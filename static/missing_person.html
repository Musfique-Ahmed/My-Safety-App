<!DOCTYPE html>
<html lang="en" class="light">
<head>
  <meta charset="utf-8">
  <title>My Safety – Missing Persons</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Tailwind + Icons -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide/dist/umd/lucide.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <style>
    body { font-family: 'Inter', sans-serif; }
    /* Shadow button style */
    .shadow-button {
      border-radius: 9999px;
      padding: 0.5rem 1rem;
      background-color: rgba(147, 51, 234, 0.2);
      color: #d8b4fe;
      font-weight: 600;
      box-shadow: 
        -4px -4px 8px rgba(255, 255, 255, 0.05),
        4px 4px 8px rgba(0, 0, 0, 0.5);
      transition: all 0.2s ease-in-out;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      text-decoration: none;
    }
    .light .shadow-button {
      background-color: #f3f4f6;
      color: #4c1d95;
      box-shadow: 
        -4px -4px 8px rgba(255, 255, 255, 1),
        4px 4px 8px rgba(0, 0, 0, 0.1);
    }
    .shadow-button:hover {
      box-shadow: 
        -2px -2px 4px rgba(255, 255, 255, 0.1), 
        2px 2px 4px rgba(0, 0, 0, 0.6);
      transform: scale(0.98);
    }
    .light .shadow-button:hover {
      box-shadow: 
        -2px -2px 4px rgba(255, 255, 255, 0.8), 
        2px 2px 4px rgba(0, 0, 0, 0.15);
    }
  </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200">

<!-- ===== HEADER ===== -->
<header class="sticky top-0 z-50 bg-white dark:bg-gray-900/50 border-b border-gray-200 dark:border-gray-800 p-4 flex items-center justify-between shadow-md">
  <div class="flex items-center space-x-3">
    <div class="flex items-center justify-center text-purple-600 dark:text-purple-500">
      <i data-lucide="shield" class="w-8 h-8"></i>
    </div>
    <h1 class="text-xl font-bold text-gray-900 dark:text-white hidden sm:block">My Safety</h1>
  </div>

  <nav class="hidden lg:flex items-center space-x-4">
        <a href="index.html" class="shadow-button text-sm">
            <i data-lucide="route" class="w-4 h-4 mr-2"></i>Safe Area
        </a>
        
        <!-- --- MODIFIED: REPORT TO POLICE DROPDOWN START (Removed onmouseover/mouseout) --- -->
        <div id="report-dropdown" class="relative">
            <button id="report-button" class="shadow-button text-sm focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-offset-2 dark:focus:ring-offset-gray-900">
                <i data-lucide="siren" class="w-4 h-4 mr-2"></i>Report to Police
            </button>
            <div id="report-dropdown-menu" 
                 class="absolute left-1/2 transform -translate-x-1/2 mt-2 w-56 bg-white dark:bg-gray-800 rounded-xl shadow-2xl border border-gray-200 dark:border-gray-700 hidden" 
                 role="menu" aria-orientation="vertical" aria-labelledby="report-button">
                <a href="report_crime.html" class="flex items-center p-3 text-sm text-gray-700 dark:text-gray-300 hover:bg-purple-100 dark:hover:bg-gray-700 hover:text-purple-600 dark:hover:text-white transition-colors rounded-t-xl">
                    <i data-lucide="message-square" class="w-5 h-5 mr-3 text-purple-500"></i>
                    Report a Crime
                </a>
                <a href="report_missing_person.html" class="flex items-center p-3 text-sm text-gray-700 dark:text-gray-300 hover:bg-purple-100 dark:hover:bg-gray-700 hover:text-purple-600 dark:hover:text-white transition-colors rounded-b-xl">
                    <i data-lucide="user-minus" class="w-5 h-5 mr-3 text-purple-500"></i>
                    Report a Missing Person
                </a>
            </div>
        </div>
        <!-- --- MODIFIED: REPORT TO POLICE DROPDOWN END --- -->
        
        <a href="wanted_criminal.html" class="shadow-button text-sm">
            <i data-lucide="users" class="w-4 h-4 mr-2"></i>Wanted Criminals
        </a>
        <a href="missing_person.html" class="shadow-button text-sm">
            <i data-lucide="search" class="w-4 h-4 mr-2"></i>Missing Persons
        </a>
    </nav>

    <div class="flex items-center space-x-4 relative" style="z-index:105;">
        <button id="panic-btn" class="flex items-center justify-center w-12 h-12 rounded-full bg-red-600 hover:bg-red-700 text-white font-bold text-lg shadow-lg z-[106] relative" title="Send Panic Alert" style="margin-right:0.5rem;">
            <i data-lucide="alert-triangle" class="w-6 h-6"></i>
        </button>

        <button id="theme-toggle" class="p-2 text-gray-500 hover:bg-gray-100 dark:hover:bg-gray-800 rounded-full transition-colors">
            <i data-lucide="sun" class="w-6 h-6 block dark:hidden"></i>
            <i data-lucide="moon" class="w-6 h-6 hidden dark:block"></i>
        </button>

        <button id="user-menu-button" class="flex items-center space-x-2 p-1 rounded-full bg-purple-600 hover:bg-purple-700 text-white transition-colors focus:outline-none z-[107] relative" style="position:relative;">
            <div class="w-8 h-8 flex items-center justify-center text-xl font-semibold rounded-full bg-white text-purple-600">F</div>
            <i data-lucide="chevron-down" class="w-4 h-4 hidden sm:block"></i>
        </button>

        <div id="user-menu" class="absolute right-0 top-full mt-2 w-64 bg-white dark:bg-gray-800 rounded-xl shadow-2xl border border-gray-200 dark:border-gray-700 hidden z-[108]" role="menu" aria-orientation="vertical" aria-labelledby="user-menu-button" style="position:absolute;">
            <div class="p-4 border-b border-gray-200 dark:border-gray-700">
                <p class="font-semibold text-gray-900 dark:text-white">Hi, Farhan!</p>
                <p class="text-sm text-gray-500 dark:text-gray-400">farhan@example.com</p>
            </div>
            <a href="user_chatbox.html" class="flex items-center p-3 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
                <i data-lucide="message-circle" class="w-5 h-5 mr-3"></i>
                Chat with Admin
            </a>
            <button onclick="window.location.href='login.html'" class="w-full text-left flex items-center p-3 text-sm text-red-600 hover:bg-red-50 dark:hover:bg-red-900/20 transition-colors rounded-b-xl">
                <i data-lucide="log-out" class="w-5 h-5 mr-3"></i>
                Logout
            </button>
        </div>
    </div>
</header>

<!-- ===== CONTENT ===== -->
<div class="container max-w-5xl mx-auto p-6">
  <h1 class="text-2xl font-bold mb-4">Missing Persons</h1>
  <div id="missingGrid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4"></div>
</div>

<!-- Modal -->
<div id="backdrop" class="fixed inset-0 bg-black/60 hidden items-center justify-center z-50">
  <div class="modal bg-white dark:bg-gray-900 border border-gray-300 dark:border-gray-700 rounded-xl max-w-2xl w-11/12">
    <header class="flex justify-between items-center border-b border-gray-200 dark:border-gray-700 p-4">
      <h2 id="modalTitle" class="text-lg font-bold">Details</h2>
      <button id="closeModal" class="px-3 py-1 rounded-lg bg-gray-200 dark:bg-gray-800">Close</button>
    </header>
    <div id="modalBody" class="p-4"></div>
  </div>
</div>

<script>
"use strict";

const API_BASE = window.location.origin.includes(":8000")
  ? ""
  : "http://127.0.0.1:8000";

lucide.createIcons();

let missingData = [];

const $ = (sel) => document.querySelector(sel);

const escapeHtml = (str) => String(str).replace(/[&<>"'`=\/]/g, (char) => ({
  '&': '&amp;',
  '<': '&lt;',
  '>': '&gt;',
  '"': '&quot;',
  "'": '&#39;',
  '`': '&#96;',
  '=': '&#61;',
  '/': '&#47;'
}[char] || char));

const fmt = (value) => {
  if (!value) return "Unknown";
  const date = typeof value === "string" ? new Date(value) : value;
  return isNaN(date.valueOf()) ? "Unknown" : date.toLocaleString();
};

const resolvePhoto = (url) => {
  if (!url) return "contents/placeholder.jpg";
  if (url.startsWith("http")) return url;
  if (url.startsWith("/")) return url;
  if (url.startsWith("static/")) return `/${url}`;
  return `/static/${url}`;
};

const secondsToHHMMSS = (seconds) => {
  const total = Math.max(0, Math.floor(Number(seconds) || 0));
  const h = String(Math.floor(total / 3600)).padStart(2, "0");
  const m = String(Math.floor((total % 3600) / 60)).padStart(2, "0");
  const s = String(total % 60).padStart(2, "0");
  return `${h}:${m}:${s}`;
};

const parseTimeField = (value) => {
  if (value === null || value === undefined || value === "") return null;
  if (typeof value === "number") return secondsToHHMMSS(value);
  const trimmed = String(value).trim();
  if (/^\d+(\.\d+)?$/.test(trimmed)) return secondsToHHMMSS(Number(trimmed));
  if (trimmed.includes(":")) return trimmed.length === 5 ? `${trimmed}:00` : trimmed;
  return null;
};

const parseHometown = (text) => {
  if (!text) return null;
  const match = String(text).match(/Hometown:\s*([^.\n]+)/i);
  return match ? match[1].trim() : null;
};

const normalizeRow = (row) => {
  const date = row.last_seen_date ? String(row.last_seen_date) : null;
  const time = parseTimeField(row.last_seen_time);
  let iso = null;
  if (date) {
    const candidate = new Date(`${date}T${time || "00:00:00"}`);
    if (!isNaN(candidate.valueOf())) iso = candidate.toISOString();
  }
  if (!iso && row.created_at) {
    const created = new Date(row.created_at);
    if (!isNaN(created.valueOf())) iso = created.toISOString();
  }

  const weight = row.weight
    ? parseFloat(String(row.weight).replace(/[^\d.]/g, "")) || null
    : null;

  return {
    id: row.missing_id,
    name: row.name || "Unknown",
    nickname: row.distinguishing_marks || null,
    photo_url: resolvePhoto(row.photo_url),
    hometown: parseHometown(row.description) || row.contact_person || "—",
    last_seen_location: row.last_seen_location || "Unknown",
    last_seen_time: iso,
    description: row.clothing_description || row.description || "",
    still_with_finder: (row.status || "").toLowerCase() === "found",
    age: row.age ?? null,
    weight_kg: weight,
    hair_color: row.hair_color || "—"
  };
};

const showStatus = (message, icon = "database") => {
  const grid = $("#missingGrid");
  grid.innerHTML = `
    <div class="col-span-full text-center text-gray-500 dark:text-gray-400 py-12">
      <i data-lucide="${icon}" class="w-10 h-10 mx-auto mb-3"></i>
      <p>${message}</p>
    </div>`;
  lucide.createIcons();
};

const render = (list = missingData) => {
  const grid = $("#missingGrid");
  grid.innerHTML = "";

  if (!list.length) {
    showStatus("No missing persons found.", "database-off");
    return;
  }

  list.forEach((item) => grid.appendChild(card(item)));
  lucide.createIcons();
};

const card = (item) => {
  const el = document.createElement("div");
  el.className =
    "rounded-xl overflow-hidden border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 shadow";
  el.innerHTML = `
    <img src="${item.photo_url}" alt="${item.name}" class="w-full h-40 object-cover" onerror="this.src='https://picsum.photos/seed/${encodeURIComponent(item.name)}/600/400'">
    <div class="p-4">
      <div class="flex justify-between items-center mb-2">
        <div class="font-semibold">${item.name} <span class="text-sm text-gray-500">(${item.nickname || "—"})</span></div>
        <span class="px-2 py-0.5 text-xs ${item.still_with_finder ? "bg-green-100 text-green-700" : "bg-yellow-100 text-yellow-700"} rounded-full">
          ${item.still_with_finder ? "With finder" : "Unknown"}
        </span>
      </div>
      <div class="text-sm text-gray-500 dark:text-gray-400">Hometown: ${item.hometown || "—"}</div>
      <div class="text-sm text-gray-500 dark:text-gray-400">Last seen: ${item.last_seen_location} · ${fmt(item.last_seen_time)}</div>
      <div class="mt-2">
        <button class="px-3 py-1 rounded-lg bg-purple-600 hover:bg-purple-700 text-white text-sm show">Show details</button>
      </div>
    </div>`;
  el.querySelector(".show").addEventListener("click", () => openModal(item));
  return el;
};

const loadMissingPersons = async () => {
  showStatus("Loading missing persons…", "loader-2");
  try {
    const response = await fetch(`${API_BASE}/api/missing-persons`, { cache: "no-store" });
    if (!response.ok) throw new Error(`HTTP ${response.status}`);
    const payload = await response.json();
    const rows = Array.isArray(payload) ? payload : payload.missing_persons || [];
    missingData = rows.map(normalizeRow);
    render();
  } catch (error) {
    console.error("Error loading missing persons:", error);
    showStatus("Unable to load data from the server.", "alert-triangle");
  }
};

const openModal = (item) => {
  $("#modalTitle").textContent = `${item.name} — Details`;
  $("#modalBody").innerHTML = `
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
      <img src="${item.photo_url}" class="rounded-lg w-full h-48 object-cover md:col-span-1" alt="${item.name}" onerror="this.src='https://picsum.photos/seed/${encodeURIComponent(item.name)}/600/400'">
      <div class="md:col-span-2 text-sm space-y-1">
        <p><b>Nickname:</b> ${item.nickname || "—"}</p>
        <p><b>Age:</b> ${item.age ?? "—"} yrs | <b>Weight:</b> ${item.weight_kg ?? "—"} kg | <b>Hair:</b> ${item.hair_color || "—"}</p>
        <p><b>Hometown:</b> ${item.hometown || "—"}</p>
        <p><b>Last seen:</b> ${item.last_seen_location} at ${fmt(item.last_seen_time)}</p>
        <p class="text-gray-500 dark:text-gray-400">${item.description || ""}</p>
        <div>
          <button id="foundBtn" class="mt-2 px-3 py-1 bg-green-500 text-white rounded">Found</button>
        </div>
        <div id="foundForm" class="hidden mt-3 p-3 border border-gray-300 dark:border-gray-700 rounded-lg bg-gray-50 dark:bg-gray-800">
          <div class="text-sm text-gray-500 mb-2">Tip: Location works only on https:// or http://localhost</div>
          <label class="block text-sm">Where did you find this person?</label>
          <input id="foundLocation" class="w-full p-2 border rounded bg-white dark:bg-gray-900 mb-2" placeholder="Type location or use GPS">
          <label class="flex items-center gap-2 text-sm mb-2">
            <input type="checkbox" id="useGps" class="w-4 h-4"> Use my current location
          </label>
          <div id="geoMsg" class="text-xs text-gray-500 mb-2"></div>
          <label class="block text-sm">Your Name</label>
          <input id="finderName" class="w-full p-2 border rounded bg-white dark:bg-gray-900 mb-2" placeholder="Your full name">
          <label class="block text-sm">Your Phone</label>
          <input id="finderPhone" class="w-full p-2 border rounded bg-white dark:bg-gray-900 mb-2" placeholder="Phone number">
          <label class="block text-sm">Your Email (optional)</label>
          <input id="finderEmail" class="w-full p-2 border rounded bg-white dark:bg-gray-900 mb-2" placeholder="Email">
          <div id="stillWrap" class="mt-4">
            <div id="stillQuestion" class="mb-2 text-sm text-yellow-600 dark:text-yellow-300">
              Is this person still with you? If yes then click <b>“Still with the finder”</b>.
            </div>
            <button id="toggleFinderBtn" class="px-3 py-1 bg-gray-500 text-white rounded">Still with the finder</button>
          </div>
          <button id="submitFound" class="mt-4 px-3 py-1 bg-purple-600 text-white rounded w-full">Submit Report</button>
        </div>
      </div>
    </div>`;

  $("#backdrop").classList.remove("hidden");
  $("#backdrop").classList.add("flex");

  $("#foundBtn").onclick = () => $("#foundForm").classList.toggle("hidden");

  $("#useGps").addEventListener("change", async (e) => {
    const msg = $("#geoMsg");
    const loc = $("#foundLocation");
    if (e.target.checked) {
      msg.textContent = "Getting your location…";
      try {
        const coords = await getCurrentCoords();
        loc.value = coords;
        msg.textContent = "Location filled from GPS.";
      } catch (err) {
        msg.textContent = "Couldn’t get location: " + err.message;
        e.target.checked = false;
      }
    } else {
      msg.textContent = "";
    }
  });

  $("#toggleFinderBtn").onclick = async () => {
    const result = await Swal.fire({
      icon: 'question',
      title: 'Is the person with you?',
      text: 'Confirm if this missing person is still with you.',
      showCancelButton: true,
      confirmButtonText: 'Yes',
      cancelButtonText: 'No',
      confirmButtonColor: '#10B981',
      cancelButtonColor: '#6B7280'
    });
    if (!result.isConfirmed) return;
    item.still_with_finder = !item.still_with_finder;
    render();
    await Swal.fire({
      icon: 'success',
      title: 'Status Updated',
      text: 'Marked as still with the finder.',
      confirmButtonColor: '#10B981'
    });
  };

  $("#submitFound").onclick = async () => {
    const location = $("#foundLocation").value.trim();
    const name = $("#finderName").value.trim();
    const phone = $("#finderPhone").value.trim();
    const email = $("#finderEmail").value.trim();
    if (!location) {
      await Swal.fire({
        icon: 'warning',
        title: 'Location Required',
        text: 'Please add a location or enable GPS before submitting.',
        confirmButtonColor: '#F59E0B'
      });
      return;
    }
    if (!name || !phone) {
      await Swal.fire({
        icon: 'warning',
        title: 'Contact Details Needed',
        text: 'Please provide your name and phone number.',
        confirmButtonColor: '#F59E0B'
      });
      return;
    }
    const payload = {
      person_id: item.id,
      found_location: location,
      finder_name: name,
      finder_phone: phone,
      finder_email: email || null,
      found_time: new Date().toISOString()
    };
    console.info('Finder report payload', payload);
    await Swal.fire({
      icon: 'success',
      title: 'Report Submitted',
      text: 'Thank you for reporting. A team member will reach out if more information is needed.',
      confirmButtonColor: '#10B981'
    });
    closeModal();
  };
};

const getCurrentCoords = () =>
  new Promise((resolve, reject) => {
    if (!("geolocation" in navigator)) return reject(new Error("Geolocation not supported."));
    navigator.geolocation.getCurrentPosition(
      (pos) =>
        resolve(`${pos.coords.latitude.toFixed(6)}, ${pos.coords.longitude.toFixed(6)}`),
      (err) => reject(err),
      { enableHighAccuracy: true, timeout: 10000 }
    );
  });

const closeModal = () => $("#backdrop").classList.add("hidden");

document.getElementById("closeModal").addEventListener("click", closeModal);
document.getElementById("backdrop").addEventListener("click", (e) => {
  if (e.target.id === "backdrop") closeModal();
});

document.addEventListener("DOMContentLoaded", () => {
  loadMissingPersons();
});

// --- UPDATED DROPDOWN LOGIC (Reporting Menu: Click-Only) ---
const reportDropdownMenu = document.getElementById('report-dropdown-menu');
const reportDropdown = document.getElementById('report-dropdown');

// 1. Event listener for clicking the button to TOGGLE the menu
document.getElementById('report-button').addEventListener('click', (e) => {
    e.preventDefault(); 
    e.stopPropagation(); // Stop propagation so the document click handler doesn't immediately close it
    reportDropdownMenu.classList.toggle('hidden');
});

// 2. Global click handler to CLOSE the menu when clicking anywhere else on the document
document.addEventListener('click', (e) => {
    // If the menu is visible AND the click target is NOT inside the entire dropdown container
    if (!reportDropdownMenu.classList.contains('hidden') && !reportDropdown.contains(e.target)) {
        reportDropdownMenu.classList.add('hidden');
    }
});

// 3. Add click listener to close menu when an item is selected 
reportDropdownMenu.querySelectorAll('a').forEach(link => {
    link.addEventListener('click', () => {
        reportDropdownMenu.classList.add('hidden');
    });
});
// Removed mouseover and mouseout handlers as requested.
// --- END UPDATED DROPDOWN LOGIC ---

// --- USER MENU DROPDOWN LOGIC ---
const userMenuButton = document.getElementById('user-menu-button');
const userMenu = document.getElementById('user-menu');

// Toggle user menu when clicking the button
userMenuButton.addEventListener('click', (e) => {
    e.preventDefault();
    e.stopPropagation();
    userMenu.classList.toggle('hidden');
});

// Close user menu when clicking outside
document.addEventListener('click', (e) => {
    if (!userMenu.classList.contains('hidden') && !userMenuButton.contains(e.target) && !userMenu.contains(e.target)) {
        userMenu.classList.add('hidden');
    }
});

// Theme toggle functionality
document.getElementById('theme-toggle').addEventListener('click', () => {
    document.documentElement.classList.toggle('dark');
});

// Panic button functionality
document.getElementById('panic-btn').addEventListener('click', async () => {
  await Swal.fire({
    icon: 'warning',
    title: 'Panic Alert Sent',
    text: 'Emergency services have been notified.',
    confirmButtonColor: '#EF4444'
  });
});
// --- END USER MENU DROPDOWN LOGIC ---

</script>
</body>
</html>