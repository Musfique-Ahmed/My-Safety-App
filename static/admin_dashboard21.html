<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard - My Safety</title>
  <link href="https://fonts.googleapis.com/css?family=Inter:400,500,600,700&display=swap" rel="stylesheet">
  <style>
    :root {
      --dark-bg: #0f0f0f;
      --dark-surface: #1a1a1a;
      --dark-card: #2a2a2a;
      --text-primary: #ffffff;
      --text-secondary: #a0a0a0;
      --text-muted: #666666;
      --accent-purple: #8b5cf6;
      --accent-gray: #6b7280;
      --accent-green: #10b981;
      --accent-red: #ef4444;
      --accent-blue: #3b82f6;
      --border-color: #333333;
    }
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: 'Inter', Arial, sans-serif;
      background: var(--dark-bg);
      color: var(--text-primary);
      line-height: 1.6;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      /* FIX: Add padding at the bottom equal to the footer height (4rem is enough for 1rem padding top/bottom + margin) */
      padding-bottom: 4rem; 
    }
    .header {
      background: var(--dark-surface);
      padding: 1rem 2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid var(--border-color);
      position: relative; /* Needed for absolute positioning of the dropdown */
    }
    .logo {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .logo-icon {
      width: 32px;
      height: 32px;
      background: var(--accent-purple);
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
    }
    .logo-text {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--text-primary);
    }
    /* Profile Menu Styles */
    .user-profile-menu {
        position: relative;
        z-index: 100;
    }
    .user-icon {
        width: 40px;
        height: 40px;
        background: var(--accent-purple);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 600;
        cursor: pointer;
        transition: box-shadow 0.2s;
        border: 2px solid var(--accent-purple);
    }
    .user-icon:hover {
        box-shadow: 0 0 10px rgba(139, 92, 246, 0.6);
    }
    .dropdown-menu {
        position: absolute;
        top: 50px; /* Position below the icon */
        right: 0;
        width: 250px;
        background: var(--dark-surface);
        border-radius: 8px;
        border: 1px solid var(--border-color);
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.5);
        opacity: 0;
        visibility: hidden;
        transform: translateY(-10px);
        transition: opacity 0.2s, transform 0.2s, visibility 0.2s;
        padding: 1rem;
    }
    .dropdown-menu.active {
        opacity: 1;
        visibility: visible;
        transform: translateY(0);
    }
    .profile-info {
        padding-bottom: 1rem;
        margin-bottom: 1rem;
        border-bottom: 1px solid var(--border-color);
    }
    .profile-info p {
        font-size: 0.875rem;
        color: var(--text-secondary);
        margin-bottom: 0.25rem;
    }
    .profile-info strong {
        color: var(--text-primary);
        font-weight: 600;
    }
    .dropdown-menu .logout-btn {
        width: 100%;
        justify-content: center;
        margin: 0;
        padding: 0.75rem;
    }
    /* End Profile Menu Styles */


    .nav-links {
      display: none; 
      gap: 2rem;
      align-items: center;
    }
    .nav-links a {
      color: var(--text-secondary);
      text-decoration: none;
      font-weight: 500;
      transition: color 0.2s;
    }
    .nav-links a:hover {
      color: var(--text-primary);
    }
    .logout-btn { 
      background: var(--accent-red);
      color: white;
      border: 1px solid var(--accent-red);
      padding: 0.5rem 1rem;
      border-radius: 6px;
      text-decoration: none;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      transition: all 0.2s;
    }
    .logout-btn:hover { 
      background: #dc2626;
      box-shadow: 0 0 10px rgba(239, 68, 68, 0.4);
    }
    .main-content {
      padding: 2rem;
      max-width: 1400px;
      margin: 0 auto;
      flex-grow: 1; 
      width: 100%; 
    }
    .dashboard-title {
      font-size: 2.5rem;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 0.5rem;
    }
    .dashboard-subtitle {
      font-size: 1rem;
      color: var(--text-secondary);
      margin-bottom: 2rem;
    }
    .admin-tabs {
      display: flex;
      gap: 1rem;
      margin-bottom: 2rem;
      border-bottom: 1px solid var(--border-color);
    }
    .tab-btn {
      background: transparent;
      color: var(--text-secondary);
      border: none;
      padding: 1rem 1.5rem;
      cursor: pointer;
      font-weight: 500;
      border-bottom: 2px solid transparent;
      transition: all 0.2s;
    }
    .tab-btn.active {
      color: var(--text-primary);
      border-bottom-color: var(--accent-purple);
    }
    .tab-btn:hover {
      color: var(--text-primary);
    }
    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
    }
    .section-card {
      background: var(--dark-card);
      border-radius: 12px;
      padding: 2rem;
      margin-bottom: 2rem;
    }
    .section-title {
      font-size: 1.5rem;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 0.5rem;
    }
    .section-description {
      color: var(--text-secondary);
      margin-bottom: 1.5rem;
    }
    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }
    .form-section-title {
      margin-top: 2rem;
      margin-bottom: 0.75rem;
      font-size: 1.1rem;
      font-weight: 600;
      color: var(--text-primary);
    }
    .form-hint {
      font-size: 0.85rem;
      color: var(--text-secondary);
      margin-top: 0.35rem;
    }
    .form-group {
      display: flex;
      flex-direction: column;
    }
    .form-label {
      color: var(--text-primary);
      font-weight: 500;
      margin-bottom: 0.5rem;
    }
    .form-input, .form-select, .form-textarea {
      background: var(--dark-surface);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 0.75rem;
      color: var(--text-primary);
      font-size: 1rem;
    }
    .form-input:focus, .form-select:focus, .form-textarea:focus {
      outline: none;
      border-color: var(--accent-purple);
    }
    .form-textarea {
      resize: vertical;
      min-height: 100px;
    }
    #analytics-overview {
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    }
    .analytics-card {
      background: var(--dark-surface);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 1.5rem;
      display: flex;
      flex-direction: column;
      gap: 0.45rem;
      min-height: 140px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
    }
    .analytics-card-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 0.5rem;
    }
    .analytics-card .metric-icon {
      font-size: 1.5rem;
      line-height: 1;
    }
    .analytics-card .metric-label {
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    .analytics-card .metric-value {
      font-size: 2rem;
      font-weight: 700;
      color: var(--text-primary);
      line-height: 1.2;
    }
    .analytics-card .metric-sub {
      font-size: 0.85rem;
      color: var(--text-muted);
    }
    .analytics-card .metric-trend {
      font-size: 0.8rem;
      font-weight: 600;
    }
    .analytics-card .metric-trend.positive {
      color: var(--accent-green);
    }
    .analytics-card .metric-trend.negative {
      color: var(--accent-red);
    }
    #activity-log {
      display: flex;
      flex-direction: column;
      gap: 0.85rem;
    }
    .activity-item {
      background: var(--dark-surface);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 1rem 1.2rem;
      display: flex;
      flex-direction: column;
      gap: 0.45rem;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
    }
    .activity-item-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 0.75rem;
    }
    .activity-item-type {
      font-weight: 600;
      color: var(--text-primary);
      font-size: 0.95rem;
    }
    .activity-item-title {
      font-size: 1rem;
      font-weight: 600;
      color: var(--text-primary);
    }
    .activity-item-description {
      font-size: 0.9rem;
      color: var(--text-secondary);
    }
    .activity-item-status {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 0.25rem 0.75rem;
      border-radius: 999px;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.04em;
    }
    .activity-item-meta {
      display: flex;
      justify-content: space-between;
      gap: 0.75rem;
      flex-wrap: wrap;
      font-size: 0.8rem;
      color: var(--text-secondary);
    }
    .analytics-empty {
      color: var(--text-secondary);
      font-size: 0.9rem;
      padding: 1rem 0;
    }
    .btn {
      padding: 0.75rem 1.5rem;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      font-weight: 500;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
    }
    .btn:disabled {
      opacity: 0.55;
      cursor: not-allowed;
      pointer-events: none;
    }
    .btn-primary {
      background: var(--accent-purple);
      color: white;
    }
    .btn-primary:hover {
      background: #7c3aed;
    }
    .btn-success {
      background: var(--accent-green);
      color: white;
    }
    .btn-success:hover {
      background: #059669;
    }
    .btn-danger {
      background: var(--accent-red);
      color: white;
    }
    .btn-danger:hover {
      background: #dc2626;
    }
    .btn-secondary {
      background: var(--accent-gray);
      color: white;
    }
    .btn-secondary:hover {
      background: #4b5563;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      background: transparent;
    }
    th, td {
      padding: 1rem;
      text-align: left;
      border-bottom: 1px solid var(--border-color);
    }
    th {
      color: var(--text-secondary);
      font-weight: 500;
      font-size: 0.875rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    td {
      color: var(--text-primary);
    }
    .status-badge {
      /* FIX: Improved padding and border-radius for better visual appeal */
      padding: 0.35rem 1rem; 
      border-radius: 6px; 
      font-size: 0.75rem;
      font-weight: 600; /* Increased weight for visibility */
      text-transform: uppercase;
      letter-spacing: 0.05em;
      display: inline-block; /* Ensures padding works consistently */
      min-width: 80px; /* Ensures all badges have a minimum width */
      text-align: center;
    }
    .status-badge.status-clickable {
      cursor: pointer;
    }
    .status-pending {
      background: var(--accent-gray);
      color: white;
    }
    .status-verified {
      background: var(--accent-green);
      color: white;
    }
    .status-in-progress {
      background: var(--accent-purple);
      color: white;
    }
    .status-resolved {
      background: var(--accent-blue);
      color: white;
    }
    .status-reported {
      background: var(--accent-gray);
      color: white;
    }
    .status-under-investigation {
      background: var(--accent-purple);
      color: white;
    }
    .status-case-closed {
      background: var(--accent-green);
      color: white;
    }
    .danger-badge {
      display: inline-block;
      padding: 0.3rem 0.75rem;
      border-radius: 999px;
      font-size: 0.75rem;
      font-weight: 600;
      letter-spacing: 0.04em;
      text-transform: uppercase;
    }
    .danger-low {
      background: rgba(16, 185, 129, 0.15);
      color: var(--accent-green);
    }
    .danger-medium {
      background: rgba(245, 158, 11, 0.18);
      color: #fbbf24;
    }
    .danger-high {
      background: rgba(239, 68, 68, 0.18);
      color: var(--accent-red);
    }
    .danger-extreme {
      background: rgba(139, 92, 246, 0.2);
      color: var(--accent-purple);
    }
    .danger-unknown {
      background: rgba(107, 114, 128, 0.2);
      color: var(--accent-gray);
    }
    .sightings-history {
      list-style: none;
      padding: 0;
      margin: 0;
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
      max-height: 320px;
      overflow-y: auto;
    }
    .sightings-history li {
      background: rgba(255, 255, 255, 0.04);
      border: 1px solid rgba(255, 255, 255, 0.06);
      border-radius: 8px;
      padding: 0.75rem;
      display: flex;
      flex-direction: column;
      gap: 0.35rem;
      font-size: 0.9rem;
    }
    .sightings-history .sighting-meta {
      color: var(--text-secondary);
      font-size: 0.8rem;
    }
    .action-btn {
      background: transparent;
      color: var(--text-secondary);
      border: none;
      padding: 0.5rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.875rem;
      transition: color 0.2s;
    }
    .action-btn:hover {
      color: var(--text-primary);
    }
    .chat-container {
      display: grid;
      grid-template-columns: 300px 1fr;
      gap: 1rem;
      height: 500px; /* Locked height for the whole chat interface */
    }
    .chat-sidebar {
      background: var(--dark-surface);
      border-radius: 8px;
      padding: 1rem;
      overflow-y: auto;
    }
    .chat-user {
      padding: 0.75rem;
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.2s;
      margin-bottom: 0.5rem;
    }
    .chat-user:hover, .chat-user.active {
      background: var(--dark-card);
    }
    .chat-main {
      background: var(--dark-surface);
      border-radius: 8px;
      display: flex;
      flex-direction: column;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2); 
      /* FIX: Add overflow hidden to clip content to the border radius */
      overflow: hidden; 
    }
    .chat-header {
      padding: 1rem;
      border-bottom: 1px solid var(--border-color);
    }
    .chat-messages {
      flex: 1; 
      padding: 1rem;
      overflow-y: auto; /* Re-enabled scrolling for message history */
      display: flex; 
      flex-direction: column;
      gap: 0.5rem; 
    }
    .chat-input-container {
      padding: 1rem;
      border-top: 1px solid var(--border-color);
      display: flex; 
      gap: 0.5rem;
      align-items: center;
      /* FIX: Ensure the background color covers the entire area right up to the bottom edge */
      background: var(--dark-surface);
    }
    .chat-input {
      flex: 1;
      background: var(--dark-card);
      border: 1px solid var(--border-color);
      border-radius: 20px; 
      padding: 0.75rem 1rem;
      color: var(--text-primary);
      font-size: 1rem;
      transition: border-color 0.2s;
    }
    .chat-input:focus {
      border-color: var(--accent-purple);
    }
    .message {
      margin-bottom: 0.5rem; 
      padding: 0.75rem 1rem;
      border-radius: 12px;
      max-width: 75%; 
      line-height: 1.4;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1); 
    }
    .message.admin {
      background: var(--accent-purple);
      color: white;
      margin-left: auto;
      /* Adjusted borders for a cleaner bubble look */
      border-bottom-right-radius: 4px; 
      border-top-right-radius: 12px;
      border-top-left-radius: 12px;
      border-bottom-left-radius: 12px;
    }
    .message.user {
      background: var(--dark-card);
      border: 1px solid var(--border-color);
      margin-right: auto;
      /* Adjusted borders for a cleaner bubble look */
      border-bottom-left-radius: 4px; 
      border-top-right-radius: 12px;
      border-top-left-radius: 12px;
      border-bottom-right-radius: 12px;
    }
    .message-sender {
      font-weight: 600; 
      font-size: 0.875rem;
      margin-bottom: 0.25rem;
    }
    .message.user .message-sender {
      color: var(--accent-purple); 
    }
    .message-time {
      font-size: 0.7rem; 
      color: var(--text-muted); 
      margin-top: 0.3rem; 
      display: block;
      text-align: right;
      opacity: 0.8;
    }
    .message.admin .message-time {
      color: rgba(255, 255, 255, 0.6); 
    }
    /* Send button change for cleaner integration */
    .chat-input-container .btn {
      padding: 0.75rem 1rem;
    }
    .footer {
      /* CRITICAL FIX: Ensures footer is always at the bottom of the viewport */
      position: fixed; 
      bottom: 0;
      left: 0;
      width: 100%;
      z-index: 999; 

      background: var(--dark-surface);
      padding: 1rem 2rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      color: var(--text-secondary);
      font-size: 0.875rem;
      border-top: 1px solid var(--border-color); 
    }
    .footer-icon {
      width: 20px;
      height: 20px;
      background: var(--accent-purple);
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 0.75rem;
      font-weight: bold;
    }

    /* Custom Modal Styles (for non-blocking UI) */
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.7);
        display: none; 
        justify-content: center;
        align-items: center;
        z-index: 1000;
        opacity: 0;
        transition: opacity 0.3s ease-in-out;
    }

    .modal-overlay.show {
        display: flex;
        opacity: 1;
    }
    
    .modal-content {
        background: var(--dark-card);
        border-radius: 12px;
        padding: 1.5rem;
        width: 90%;
        max-width: 400px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        transform: translateY(-20px);
        transition: transform 0.3s ease-in-out;
    }

    .modal-overlay.show .modal-content {
        transform: translateY(0);
    }

    .modal-message {
        font-size: 1.1rem;
        margin-bottom: 1.5rem;
        color: var(--text-primary);
    }

  .modal-buttons {
    display: flex;
    justify-content: flex-end;
    gap: 0.75rem;
    flex-wrap: wrap;
  }

  .modal-buttons.stacked {
    flex-direction: column;
    align-items: stretch;
  }

  .modal-buttons.stacked .btn {
    width: 100%;
    justify-content: center;
  }

  .stats-modal {
    display: flex;
    flex-direction: column;
    gap: 1.25rem;
  }

  .stats-header {
    display: flex;
    flex-direction: column;
    gap: 0.35rem;
  }

  .stats-header h3 {
    font-size: 1.35rem;
    font-weight: 600;
    margin: 0;
  }

  .stats-header p {
    margin: 0;
    color: var(--text-secondary);
    font-size: 0.9rem;
  }

  .stats-metrics {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 0.85rem;
  }

  .stats-metric {
    background: rgba(255, 255, 255, 0.04);
    border: 1px solid rgba(255, 255, 255, 0.06);
    border-radius: 10px;
    padding: 0.85rem;
    display: flex;
    flex-direction: column;
    gap: 0.2rem;
  }

  .stats-metric span {
    display: block;
  }

  .stats-metric .metric-label {
    color: var(--text-secondary);
    font-size: 0.8rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .stats-metric .metric-value {
    font-size: 1.4rem;
    font-weight: 600;
  }

  .stats-layout {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 1.25rem;
    align-items: stretch;
  }

  .stats-metrics-card {
    background: rgba(255, 255, 255, 0.04);
    border: 1px solid rgba(255, 255, 255, 0.06);
    border-radius: 12px;
    padding: 1rem;
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .stats-chart {
    background: rgba(255, 255, 255, 0.04);
    border: 1px solid rgba(255, 255, 255, 0.06);
    border-radius: 12px;
    padding: 1rem;
  }

  .stats-chart h4 {
    margin: 0 0 0.75rem 0;
    font-size: 1rem;
    font-weight: 600;
  }

  .chart-wrapper {
    position: relative;
    height: 220px;
  }

  .stats-insights {
    background: rgba(255, 255, 255, 0.03);
    border: 1px dashed rgba(255, 255, 255, 0.08);
    border-radius: 12px;
    padding: 0.9rem 1rem;
  }

  .stats-insights h4 {
    margin: 0 0 0.5rem 0;
    font-size: 0.95rem;
    font-weight: 600;
    color: var(--text-primary);
    text-transform: uppercase;
    letter-spacing: 0.04em;
  }

  .stats-insights ul {
    list-style: none;
    padding: 0;
    margin: 0;
    display: flex;
    flex-direction: column;
    gap: 0.35rem;
  }

  .stats-insights li {
    color: var(--text-secondary);
    font-size: 0.88rem;
  }

  .stats-empty-state {
    text-align: center;
    color: var(--text-secondary);
    font-size: 0.95rem;
    padding: 1.5rem 0;
  }

  .modal-content.modal-wide {
    max-width: 1040px;
    width: 95%;
  }

  .missing-modal {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .missing-modal .missing-header h3 {
    margin: 0;
    font-size: 1.45rem;
    font-weight: 600;
  }

  .missing-modal .missing-header p {
    margin: 0;
    color: var(--text-secondary);
    font-size: 0.9rem;
  }

  .missing-modal .missing-body {
    display: grid;
    grid-template-columns: minmax(0, 1.75fr) minmax(240px, 1fr);
    gap: 1rem;
    align-items: stretch;
  }

  .missing-modal .missing-details {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
    gap: 0.85rem;
  }

  .missing-modal .missing-details .stats-insights {
    height: 100%;
  }

  .missing-modal .missing-details .missing-description {
    grid-column: 1 / -1;
  }

  .missing-modal .missing-sidebar {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .missing-photo-card {
    background: rgba(255, 255, 255, 0.04);
    border: 1px solid rgba(255, 255, 255, 0.06);
    border-radius: 12px;
    padding: 0.75rem;
    display: flex;
    align-items: center;
    justify-content: center;
    min-height: 220px;
  }

  .missing-photo-card img {
    width: 100%;
    border-radius: 10px;
    object-fit: cover;
  }

  .missing-photo-card.missing-photo-placeholder {
    color: var(--text-secondary);
    font-size: 0.9rem;
    text-align: center;
  }

  @media (max-width: 900px) {
    .stats-layout {
      grid-template-columns: 1fr;
    }
  }

  @media (max-width: 900px) {
    .missing-modal .missing-body {
      grid-template-columns: 1fr;
    }
  }

    /* Adjust button styles for modal */
    .modal-buttons .btn {
        padding: 0.6rem 1.25rem;
        font-size: 0.9rem;
    }

    .modal-buttons .btn-secondary {
        background: var(--dark-surface);
        color: var(--text-primary);
    }
    .modal-buttons .btn-secondary:hover {
        background: var(--border-color);
    }
    /* End Custom Modal Styles */
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
</head>
<body>
  <!-- Custom Modal HTML Structure -->
  <div id="custom-modal-overlay" class="modal-overlay" onclick="closeModal(event)">
    <div class="modal-content">
      <div id="modal-message" class="modal-message"></div>
      <div id="modal-buttons" class="modal-buttons">
        <!-- Buttons injected by JS -->
      </div>
    </div>
  </div>
  <!-- End Custom Modal HTML Structure -->

  <div class="header">
    <div class="logo">
      <div class="logo-icon">🛡️</div>
      <div class="logo-text">My Safety</div>
    </div>
    
    <!-- Admin Profile Dropdown Menu -->
    <div class="user-profile-menu">
        <div class="user-icon" onclick="toggleMenu()">AD</div>
        <div id="dropdown-menu" class="dropdown-menu">
            <div class="profile-info">
                <!-- ADDED Admin Name -->
                <div style="font-size: 1.1rem; font-weight: 700; color: var(--text-primary); margin-bottom: 0.5rem;">Inspector John Doe</div>
                <p>Role: <strong>Super Admin</strong></p>
                <p>ID: <strong>ADM-90210</strong></p>
                <p>Email: <strong>admin@mysafety.com</strong></p>
                <p>Status: <strong style="color: var(--accent-green);">Active</strong></p>
            </div>
            <!-- Logout button inside the dropdown -->
            <a href="/static/login.html" class="logout-btn" onclick="handleLogout(event)">
                <span>←</span>
                Logout
            </a>
        </div>
    </div>
    <!-- End Admin Profile Dropdown Menu -->
  </div>

  <div class="main-content">
    <h1 class="dashboard-title">Admin Dashboard</h1>
    <p class="dashboard-subtitle">Manage crimes, verify reports, update cases, and communicate with reporters.</p>

    <div class="admin-tabs">
      <button class="tab-btn active" onclick="showTab('overview', event)">Overview</button>
      <button class="tab-btn" onclick="showTab('users', event)">Users</button>
      <button class="tab-btn" onclick="showTab('wanted-criminals', event)">Wanted Criminals</button>
      <button class="tab-btn" onclick="showTab('police-stations', event)">Police Stations</button>
      <button class="tab-btn" onclick="showTab('missing-persons', event)">Missing Persons</button>
      <button class="tab-btn" onclick="showTab('add-crime', event)">Add Crime</button>
      <button class="tab-btn" onclick="showTab('verify-reports', event)">Verify Reports</button>
      <button class="tab-btn" onclick="showTab('case-management', event)">Case Management</button>
      <!--<button class="tab-btn" onclick="showTab('chat', event)">Chat</button>-->
      <button class="tab-btn" onclick="showTab('analytics', event)">Analytics</button>
    </div>

    <!-- Overview Tab -->
    <div id="overview" class="tab-content active">
      <div class="section-card">
        <h2 class="section-title">Crime Reports</h2>
        <p class="section-description">A list of all submitted crime reports. Select a report to view details and generate an AI summary.</p>
        
        <table>
          <thead>
            <tr>
              <th>Report ID</th>
              <th>Location</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="crimes-table">
            <!-- Data will be loaded dynamically -->
          </tbody>
        </table>
      </div>
    </div>

    <!-- Users Management Tab -->
    <div id="users" class="tab-content">
      <div class="section-card">
        <h2 class="section-title">User Management</h2>
        <p class="section-description">Manage user accounts, roles, and permissions.</p>
        
        <div style="margin-bottom: 1rem;">
          <button class="btn btn-primary" onclick="showUserStats()">
            <span>📊</span>
            View User Statistics
          </button>
        </div>
        
        <table>
          <thead>
            <tr>
              <th>User ID</th>
              <th>Username</th>
              <th>Email</th>
              <th>Role</th>
              <th>Status</th>
              <th>Created</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="users-table">
            <!-- Data will be loaded dynamically -->
          </tbody>
        </table>
      </div>
    </div>

    <!-- Wanted Criminals Management Tab -->
    <div id="wanted-criminals" class="tab-content">
      <div class="section-card">
        <h2 class="section-title">Wanted Criminals Management</h2>
        <p class="section-description">Add, edit, and manage wanted criminals database.</p>
        
        <div style="margin-bottom: 1rem;">
          <button class="btn btn-primary" onclick="showAddCriminalForm()">
            <span>➕</span>
            Add Wanted Criminal
          </button>
        </div>
        
        <table>
          <thead>
            <tr>
              <th>Criminal ID</th>
              <th>Name</th>
              <th>Alias</th>
              <th>Crimes</th>
              <th>Danger Level</th>
              <th>Reward</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="wanted-criminals-table">
            <!-- Data will be loaded dynamically -->
          </tbody>
        </table>
      </div>

      <!-- Add Criminal Form (Hidden by default) -->
      <div id="add-criminal-form" class="section-card" style="display: none;">
        <h2 class="section-title">Add New Wanted Criminal</h2>
        <form id="criminal-form">
          <div class="form-grid">
            <div class="form-group">
              <label class="form-label">Full Name</label>
              <input type="text" class="form-input" name="name" required>
            </div>
            <div class="form-group">
              <label class="form-label">Alias</label>
              <input type="text" class="form-input" name="alias">
            </div>
            <div class="form-group">
              <label class="form-label">Age Range</label>
              <input type="text" class="form-input" name="age_range" placeholder="e.g., 25-30" required>
            </div>
            <div class="form-group">
              <label class="form-label">Gender</label>
              <select class="form-select" name="gender" required>
                <option value="">Select Gender</option>
                <option value="M">Male</option>
                <option value="F">Female</option>
                <option value="O">Other</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">Height</label>
              <input type="text" class="form-input" name="height" placeholder="e.g., 175 cm">
            </div>
            <div class="form-group">
              <label class="form-label">Weight</label>
              <input type="text" class="form-input" name="weight" placeholder="e.g., 70 kg">
            </div>
            <div class="form-group">
              <label class="form-label">Hair Color</label>
              <input type="text" class="form-input" name="hair_color">
            </div>
            <div class="form-group">
              <label class="form-label">Eye Color</label>
              <input type="text" class="form-input" name="eye_color">
            </div>
            <div class="form-group">
              <label class="form-label">Danger Level</label>
              <select class="form-select" name="danger_level" required>
                <option value="Low">Low</option>
                <option value="Medium" selected>Medium</option>
                <option value="High">High</option>
                <option value="Extreme">Extreme</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">Reward Amount (BDT)</label>
              <input type="number" class="form-input" name="reward_amount" min="0">
            </div>
            <div class="form-group">
              <label class="form-label">Last Known Location</label>
              <input type="text" class="form-input" name="last_known_location">
            </div>
            <div class="form-group">
              <label class="form-label">Photo</label>
              <input type="file" class="form-input" name="photo_file" accept="image/*">
              <span style="color: var(--text-secondary); font-size: 0.8rem;">Accepted formats: JPG, PNG (max 5 MB)</span>
            </div>
          </div>
          
          <div class="form-group">
            <label class="form-label">Description</label>
            <textarea class="form-textarea" name="description" required></textarea>
          </div>
          
          <div class="form-group">
            <label class="form-label">Distinguishing Marks</label>
            <textarea class="form-textarea" name="distinguishing_marks"></textarea>
          </div>
          
          <div class="form-group">
            <label class="form-label">Crimes Committed</label>
            <textarea class="form-textarea" name="crimes_committed" placeholder="List crimes separated by commas" required></textarea>
          </div>
          
          <div style="margin-top: 2rem;">
            <button type="submit" class="btn btn-primary">
              <span>➕</span>
              Add Criminal
            </button>
            <button type="button" class="btn btn-secondary" onclick="hideAddCriminalForm()">
              <span>❌</span>
              Cancel
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Police Stations Management Tab -->
    <div id="police-stations" class="tab-content">
      <div class="section-card">
        <h2 class="section-title">Police Stations Management</h2>
        <p class="section-description">Manage police station information and jurisdictions.</p>
        
        <div style="margin-bottom: 1rem;">
          <button class="btn btn-primary" onclick="showAddStationForm()">
            <span>➕</span>
            Add Police Station
          </button>
        </div>
        
        <table>
          <thead>
            <tr>
              <th>Station ID</th>
              <th>Station Name</th>
              <th>Station Code</th>
              <th>Address</th>
              <th>Phone</th>
              <th>Jurisdiction</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="stations-table">
            <!-- Data will be loaded dynamically -->
          </tbody>
        </table>
      </div>

      <!-- Add Station Form (Hidden by default) -->
      <div id="add-station-form" class="section-card" style="display: none;">
        <h2 class="section-title">Add New Police Station</h2>
        <form id="station-form">
          <div class="form-grid">
            <div class="form-group">
              <label class="form-label">Station Name</label>
              <input type="text" class="form-input" name="station_name" required>
            </div>
            <div class="form-group">
              <label class="form-label">Station Code</label>
              <input type="text" class="form-input" name="station_code" required>
            </div>
            <div class="form-group">
              <label class="form-label">Phone</label>
              <input type="tel" class="form-input" name="phone">
            </div>
            <div class="form-group">
              <label class="form-label">Email</label>
              <input type="email" class="form-input" name="email">
            </div>
            <div class="form-group">
              <label class="form-label">Officer in Charge</label>
              <input type="text" class="form-input" name="officer_in_charge">
            </div>
            <div class="form-group">
              <label class="form-label">Latitude</label>
              <input type="number" step="any" class="form-input" name="latitude">
            </div>
            <div class="form-group">
              <label class="form-label">Longitude</label>
              <input type="number" step="any" class="form-input" name="longitude">
            </div>
          </div>
          
          <div class="form-group">
            <label class="form-label">Address</label>
            <textarea class="form-textarea" name="address"></textarea>
          </div>
          
          <div class="form-group">
            <label class="form-label">Jurisdiction Area</label>
            <textarea class="form-textarea" name="jurisdiction_area"></textarea>
          </div>
          
          <div style="margin-top: 2rem;">
            <button type="submit" class="btn btn-primary">
              <span>➕</span>
              Add Station
            </button>
            <button type="button" class="btn btn-secondary" onclick="hideAddStationForm()">
              <span>❌</span>
              Cancel
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Missing Persons Management Tab -->
    <div id="missing-persons" class="tab-content">
      <div class="section-card">
        <h2 class="section-title">Missing Persons Management</h2>
        <p class="section-description">View and manage missing person reports.</p>
        
        <table>
          <thead>
            <tr>
              <th>Missing ID</th>
              <th>Name</th>
              <th>Age</th>
              <th>Gender</th>
              <th>Last Seen Location</th>
              <th>Last Seen Date</th>
                <th>Reporter Info</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="missing-persons-table">
            <!-- Data will be loaded dynamically -->
          </tbody>
        </table>
      </div>
    </div>

    <!-- Add Crime Tab -->
    <div id="add-crime" class="tab-content">
      <div class="section-card">
        <h2 class="section-title">Add New Crime Report</h2>
        <p class="section-description">Manually add a crime report to the system.</p>
        
        <form id="add-crime-form">
          <div class="form-grid">
            <div class="form-group">
              <label class="form-label">Crime Type</label>
              <select class="form-select" name="crime_type" required>
                <option value="">Select Crime Type</option>
                <option value="theft">Theft</option>
                <option value="burglary">Burglary</option>
                <option value="robbery">Robbery</option>
                <option value="assault">Assault</option>
                <option value="murder">Murder</option>
                <option value="kidnapping">Kidnapping</option>
                <option value="fraud">Fraud</option>
                <option value="cybercrime">Cybercrime</option>
                <option value="drug_offense">Drug Offense</option>
                <option value="vandalism">Vandalism</option>
                <option value="domestic_violence">Domestic Violence</option>
                <option value="other">Other</option>
              </select>
            </div>
            
            <div class="form-group">
              <label class="form-label">Status</label>
              <select class="form-select" name="status" required>
                <option value="reported">Reported</option>
                <option value="under_investigation">Under Investigation</option>
                <option value="pending">Pending</option>
                <option value="resolved">Resolved</option>
              </select>
            </div>
            
            <div class="form-group">
              <label class="form-label">City</label>
              <select class="form-select" name="city" required>
                <option value="">Select City</option>
                <option value="Dhaka">Dhaka</option>
                <option value="Chittagong">Chittagong</option>
                <option value="Sylhet">Sylhet</option>
                <option value="Rajshahi">Rajshahi</option>
                <option value="Khulna">Khulna</option>
                <option value="Barisal">Barisal</option>
              </select>
            </div>
            
            <div class="form-group">
              <label class="form-label">Area Name</label>
              <input type="text" class="form-input" name="area_name" required placeholder="e.g., Dhanmondi">
            </div>
            
            <div class="form-group">
              <label class="form-label">Date & Time</label>
              <input type="datetime-local" class="form-input" name="incident_time" required>
            </div>
            
            <div class="form-group">
              <label class="form-label">Priority Level</label>
              <select class="form-select" name="priority">
                <option value="low">Low</option>
                <option value="medium" selected>Medium</option>
                <option value="high">High</option>
              </select>
            </div>
          </div>
          
          <div class="form-group">
            <label class="form-label">Crime Description</label>
            <textarea class="form-textarea" name="description" required placeholder="Detailed description of the crime..."></textarea>
          </div>
          
          <div class="form-group">
            <label class="form-label">Location Details</label>
            <textarea class="form-textarea" name="location_details" placeholder="Specific location details, landmarks, etc."></textarea>
          </div>
          
          <h3 class="form-section-title">Victim Details (Optional)</h3>
          <div class="form-grid">
            <div class="form-group">
              <label class="form-label">Victim Name</label>
              <input type="text" class="form-input" name="victim_name" placeholder="e.g., Jane Doe">
            </div>
            <div class="form-group">
              <label class="form-label">Victim Age</label>
              <input type="number" class="form-input" name="victim_age" min="0" placeholder="Age in years">
            </div>
            <div class="form-group">
              <label class="form-label">Victim Gender</label>
              <select class="form-select" name="victim_gender">
                <option value="">Select Gender</option>
                <option value="Female">Female</option>
                <option value="Male">Male</option>
                <option value="Other">Other</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">Victim Contact</label>
              <input type="text" class="form-input" name="victim_contact" placeholder="Phone or email for follow-up">
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">Victim Notes</label>
            <textarea class="form-textarea" name="victim_notes" placeholder="Injuries, medical needs, or other relevant details."></textarea>
          </div>

          <h3 class="form-section-title">Suspect Details (Optional)</h3>
          <div class="form-grid">
            <div class="form-group">
              <label class="form-label">Suspect Name</label>
              <input type="text" class="form-input" name="criminal_name" placeholder="e.g., John Smith">
            </div>
            <div class="form-group">
              <label class="form-label">Known Alias</label>
              <input type="text" class="form-input" name="criminal_alias" placeholder="Alias or nickname">
            </div>
            <div class="form-group">
              <label class="form-label">Last Known Location</label>
              <input type="text" class="form-input" name="criminal_last_known" placeholder="e.g., Mirpur, Dhaka">
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">Suspect Description</label>
            <textarea class="form-textarea" name="criminal_description" placeholder="Physical characteristics, distinctive marks, etc."></textarea>
          </div>

          <h3 class="form-section-title">Weapon Details (Optional)</h3>
          <div class="form-grid">
            <div class="form-group">
              <label class="form-label">Weapon Type</label>
              <input type="text" class="form-input" name="weapon_type" placeholder="e.g., Handgun, Knife">
            </div>
            <div class="form-group">
              <label class="form-label">Recovery Status</label>
              <select class="form-select" name="weapon_recovered">
                <option value="">Unknown</option>
                <option value="Recovered">Recovered</option>
                <option value="Not Recovered">Not Recovered</option>
              </select>
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">Weapon Description</label>
            <textarea class="form-textarea" name="weapon_description" placeholder="Additional context about the weapon involved."></textarea>
          </div>

          <h3 class="form-section-title">Witness Details (Optional)</h3>
          <div class="form-grid">
            <div class="form-group">
              <label class="form-label">Witness Name</label>
              <input type="text" class="form-input" name="witness_name" placeholder="e.g., Abdul Karim">
            </div>
            <div class="form-group">
              <label class="form-label">Witness Contact</label>
              <input type="text" class="form-input" name="witness_contact" placeholder="Phone or email for coordination">
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">Witness Statement</label>
            <textarea class="form-textarea" name="witness_statement" placeholder="Summary of what the witness observed."></textarea>
          </div>

          <h3 class="form-section-title">Evidence Uploads (Optional)</h3>
          <div class="form-group">
            <label class="form-label">Upload Evidence Files</label>
            <input type="file" class="form-input" id="evidence-files-input" name="evidence_files" multiple accept=".jpg,.jpeg,.png,.pdf,.doc,.docx,.xls,.xlsx,.mp3,.mp4,.zip,.txt">
            <p class="form-hint">Select one or more files (max 5&nbsp;MB each). Files are stored securely with the crime record.</p>
          </div>

          <div style="margin-top: 2rem;">
            <button type="submit" class="btn btn-primary">
              <span>➕</span>
              Add Crime Report
            </button>
            <button type="reset" class="btn btn-secondary">
              <span>🔄</span>
              Reset Form
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Verify Reports Tab -->
    <div id="verify-reports" class="tab-content">
      <div class="section-card">
        <h2 class="section-title">Verify User Reports</h2>
        <p class="section-description">Review and verify complaints submitted by users.</p>
        
        <table>
          <thead>
            <tr>
              <th>Complaint ID</th>
              <th>Reporter Contact</th>
              <th>Reported At</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="complaints-table">
            <!-- Data will be loaded dynamically -->
          </tbody>
        </table>
      </div>
    </div>

    <!-- Case Management Tab -->
    <div id="case-management" class="tab-content">
      <div class="section-card">
        <h2 class="section-title">Case Assignment & Management</h2>
        <p class="section-description">Assign cases to officers and track progress.</p>
        
        <div style="margin-bottom: 1rem;">
          <button class="btn btn-primary" onclick="showAssignCaseForm()">
            <span>👮</span>
            Assign New Case
          </button>
        </div>
        
        <table>
          <thead>
            <tr>
              <th>Assignment ID</th>
              <th>Crime ID</th>
              <th>Assigned Officer</th>
              <th>Role</th>
              <th>Assigned At</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="assignments-table">
            <!-- Data will be loaded dynamically -->
          </tbody>
        </table>
      </div>
      
      <!-- Assign Case Form (Hidden by default) -->
      <div id="assign-case-form" class="section-card" style="display: none;">
        <h2 class="section-title">Assign Case to Officer</h2>
        <form id="case-assignment-form">
          <div class="form-grid">
            <div class="form-group">
              <label class="form-label">Crime ID</label>
              <input type="number" class="form-input" name="crime_id" required placeholder="Enter Crime ID">
            </div>
            <div class="form-group">
              <label class="form-label">Officer ID</label>
              <input type="number" class="form-input" name="user_id" required placeholder="Enter Officer ID">
            </div>
            <div class="form-group">
              <label class="form-label">Duty Role</label>
              <select class="form-select" name="duty_role" required>
                <option value="">Select Role</option>
                <option value="Lead Investigator">Lead Investigator</option>
                <option value="Assistant Investigator">Assistant Investigator</option>
                <option value="Evidence Collector">Evidence Collector</option>
                <option value="Initial Assessment">Initial Assessment</option>
                <option value="Follow-up">Follow-up</option>
              </select>
            </div>
          </div>
          
          <div style="margin-top: 2rem;">
            <button type="submit" class="btn btn-primary">
              <span>✅</span>
              Assign Case
            </button>
            <button type="button" class="btn btn-secondary" onclick="hideAssignCaseForm()">
              <span>❌</span>
              Cancel
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Chat Tab -->
    <div id="chat" class="tab-content">
      <div class="section-card">
        <h2 class="section-title">User Communication</h2>
        <p class="section-description">Chat with users who have submitted reports.</p>
        
        <div class="chat-container">
          <div class="chat-sidebar">
            <h3 style="margin-bottom: 1rem; color: var(--text-primary);">Active Conversations</h3>
            <div class="chat-user active" data-user-id="john-doe" onclick="selectUser('john-doe', event)">
              <div style="font-weight: 600;">John Doe</div>
              <div style="font-size: 0.875rem; color: var(--text-secondary);">Report: UR-001</div>
            </div>
            <div class="chat-user" data-user-id="jane-smith" onclick="selectUser('jane-smith', event)">
              <div style="font-weight: 600;">Jane Smith</div>
              <div style="font-size: 0.875rem; color: var(--text-secondary);">Report: UR-002</div>
            </div>
            <div class="chat-user" data-user-id="mike-johnson" onclick="selectUser('mike-johnson', event)">
              <div style="font-weight: 600;">Mike Johnson</div>
              <div style="font-size: 0.875rem; color: var(--text-secondary);">Report: UR-003</div>
            </div>
          </div>
          
          <div class="chat-main">
            <div class="chat-header">
              <div style="font-weight: 600;" id="chat-header-name">John Doe</div>
              <div style="font-size: 0.875rem; color: var(--text-secondary);" id="chat-header-report">Report ID: UR-001</div>
            </div>
            
            <div class="chat-messages" id="chat-messages">
              <!-- Messages will be loaded dynamically -->
            </div>
            
            <div class="chat-input-container">
              <input type="text" class="chat-input" id="chat-input" placeholder="Type your message...">
              <button class="btn btn-primary" onclick="sendMessage()">
                <span>📤</span>
                Send
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Analytics Tab -->
    <div id="analytics" class="tab-content">
      <div class="section-card">
        <h2 class="section-title">System Analytics</h2>
        <p class="section-description">View comprehensive system statistics and trends.</p>
        
        <div class="form-grid" id="analytics-overview">
          <!-- Statistics cards will be loaded here -->
        </div>
        
        <div style="margin-top: 2rem;">
          <h3 style="color: var(--text-primary); margin-bottom: 1rem;">Recent Activity Log</h3>
          <div id="activity-log">
            <!-- Activity log will be loaded here -->
          </div>
        </div>
      </div>
    </div>

    <!-- Add these JavaScript functions before the closing </script> tag -->

    <script>
    // --- Custom Modal Functions (Replacing alert and confirm/prompt) ---
    const modalOverlay = document.getElementById('custom-modal-overlay');
    const modalMessage = document.getElementById('modal-message');
    const modalButtons = document.getElementById('modal-buttons');
  const modalContainer = modalOverlay.querySelector('.modal-content');
    function coerceModalMessage(value) {
      if (value === null || value === undefined) {
        return '';
      }
      if (value instanceof Error) {
        return value.message;
      }
      if (typeof value === 'string') {
        return value;
      }
      if (typeof value === 'object') {
        try {
          const serialized = JSON.stringify(value, null, 2);
          return serialized || String(value);
        } catch (_) {
          return String(value);
        }
      }
      return String(value);
    }

  const adminUsersCache = new Map();
  const wantedCriminalCache = new Map();
  const policeStationCache = new Map();
  const missingPersonsCache = new Map();
  const complaintsCache = new Map();
  let complaintsList = [];
    const ROLE_ACTIONS = [
      { value: 'Super Admin', label: 'Make Super Admin', className: 'btn btn-primary' },
      { value: 'Admin', label: 'Make Admin', className: 'btn btn-primary' },
      { value: 'Detective', label: 'Make Detective', className: 'btn btn-secondary' },
      { value: 'Officer', label: 'Make Officer', className: 'btn btn-secondary' },
      { value: 'User', label: 'Demote to User', className: 'btn btn-danger' }
    ];
    const chartInstances = { role: null, status: null };
  const CHART_COLOR_PALETTE = ['#8b5cf6', '#10b981', '#f59e0b', '#ef4444', '#3b82f6', '#6366f1', '#14b8a6', '#ec4899'];
  const CURRENT_ADMIN_ID = Number(window.currentAdminId || window.ADMIN_ID || 1);
    const addCriminalFormContainer = document.getElementById('add-criminal-form');
    const criminalForm = document.getElementById('criminal-form');
  const addStationFormContainer = document.getElementById('add-station-form');
  const stationForm = document.getElementById('station-form');

  function closeModal(event) {
    if (event && event.currentTarget === modalOverlay && event.target !== modalOverlay) {
      return;
    }
    modalButtons.classList.remove('stacked');
    modalContainer.classList.remove('modal-wide');
    modalOverlay.classList.remove('show');
    Object.keys(chartInstances).forEach(key => {
      if (chartInstances[key]) {
        try {
          chartInstances[key].destroy();
        } catch (_) {
          // no-op
        }
        chartInstances[key] = null;
      }
    });
  }

  function showAddCriminalForm() {
    if (!addCriminalFormContainer) {
      showAlert('Add criminal form is unavailable right now.');
      return;
    }
    addCriminalFormContainer.style.display = 'block';
    const primaryField = addCriminalFormContainer.querySelector('input[name="name"]');
    if (primaryField) {
      primaryField.focus();
    }
    addCriminalFormContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
  }

  function hideAddCriminalForm() {
    if (!addCriminalFormContainer) {
      return;
    }
    addCriminalFormContainer.style.display = 'none';
    if (criminalForm) {
      criminalForm.reset();
    }
  }

  function showAddStationForm() {
    if (!addStationFormContainer) {
      showAlert('Add police station form is unavailable right now.');
      return;
    }
    addStationFormContainer.style.display = 'block';
    const primaryField = addStationFormContainer.querySelector('input[name="station_name"]');
    if (primaryField) {
      primaryField.focus();
    }
    addStationFormContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
  }

  function hideAddStationForm() {
    if (!addStationFormContainer) {
      return;
    }
    addStationFormContainer.style.display = 'none';
    if (stationForm) {
      stationForm.reset();
    }
  }

    /**
     * Shows a custom alert modal.
     * @param {string} message - The message to display.
     */
  function showAlert(message) {
    modalContainer.classList.remove('modal-wide');
    modalMessage.textContent = coerceModalMessage(message);
        modalButtons.innerHTML = ''; // Clear previous buttons
    modalButtons.classList.remove('stacked');

  const okButton = document.createElement('button');
  okButton.className = 'btn btn-primary';
  okButton.textContent = 'OK';
  okButton.onclick = () => closeModal();
        modalButtons.appendChild(okButton);

        modalOverlay.classList.add('show');
    }

    /**
     * Shows a custom confirmation modal.
     * @param {string} message - The message to confirm.
     * @param {function(boolean): void} callback - The function to call with the result (true for yes, false for no).
     */
  function showConfirm(message, callback) {
    modalContainer.classList.remove('modal-wide');
    modalMessage.textContent = coerceModalMessage(message);
        modalButtons.innerHTML = '';
    modalButtons.classList.remove('stacked');

        const noButton = document.createElement('button');
        noButton.className = 'btn btn-secondary';
        noButton.textContent = 'No';
        noButton.onclick = () => {
            closeModal();
            callback(false);
        };
        
        const yesButton = document.createElement('button');
        yesButton.className = 'btn btn-danger';
        yesButton.textContent = 'Yes';
        yesButton.onclick = () => {
            closeModal();
            callback(true);
        };

        modalButtons.appendChild(noButton);
        modalButtons.appendChild(yesButton);
        modalOverlay.classList.add('show');
    }
    // --- End Custom Modal Functions ---

    // --- Logout Functionality ---
    function handleLogout(event) {
        event.preventDefault(); // Prevent immediate link navigation
        showConfirm("Are you sure you want to log out of the Admin Dashboard?", (confirmed) => {
            if (confirmed) {
                // In a real application, this is where you'd call a sign-out API.
                // For this mock, we redirect back to the login page.
                window.location.href = event.currentTarget.href; 
            }
        });
    }

    // --- Profile Dropdown Toggle ---
    function toggleMenu() {
        document.getElementById('dropdown-menu').classList.toggle('active');
        // Close menu if clicking outside of it (added listener to document body)
        if (document.getElementById('dropdown-menu').classList.contains('active')) {
            document.addEventListener('click', closeMenuOutside, true);
        } else {
            document.removeEventListener('click', closeMenuOutside, true);
        }
    }

    function closeMenuOutside(event) {
        const menuContainer = document.querySelector('.user-profile-menu');
        if (!menuContainer.contains(event.target)) {
            document.getElementById('dropdown-menu').classList.remove('active');
            document.removeEventListener('click', closeMenuOutside, true);
        }
    }
    
    // --- Mock Data (Kept locally to ensure the dashboard loads, as API calls would fail here) ---
    const crimesData = [
        { crime_id: 1, area_name: 'Dhanmondi', city: 'Dhaka', status: 'under_investigation' },
        { crime_id: 2, area_name: 'Khilkhet', city: 'Dhaka', status: 'reported' },
        { crime_id: 3, area_name: 'Agrabad', city: 'Chittagong', status: 'case_closed' },
        { crime_id: 4, area_name: 'Shamshernagar', city: 'Sylhet', status: 'pending' },
    ];

    const assignmentsData = [
        { assignment_id: 501, crime_id: 1, full_name: 'Officer Rahman', duty_role: 'Lead Investigator', assigned_at: new Date().toISOString(), status: 'in_progress' },
        { assignment_id: 502, crime_id: 2, full_name: 'Inspector Ali', duty_role: 'Initial Assessment', assigned_at: new Date(Date.now() - 86400000).toISOString(), status: 'reported' },
        { assignment_id: 503, crime_id: 3, full_name: 'Sergeant Khan', duty_role: 'Archive', assigned_at: new Date(Date.now() - 604800000).toISOString(), status: 'resolved' },
    ];
    
    // --- Mock Chat Messages ---
    const mockChatMessages = {
        'john-doe': [
            { sender: 'user', name: 'John Doe', text: 'I witnessed a theft incident at Dhanmondi area yesterday. Can you please look into this?', time: '2 hours ago' },
            { sender: 'admin', name: 'Admin', text: 'Thank you for reporting this. We have received your report and are investigating. Can you provide more details about the incident?', time: '1 hour ago' },
            { sender: 'user', name: 'John Doe', text: 'Sure, it happened around 3 PM near the Dhanmondi Lake area. A man snatched a woman\'s purse and ran away.', time: '30 minutes ago' },
        ],
        'jane-smith': [
            { sender: 'user', name: 'Jane Smith', text: 'I reported a suspicious vehicle near my apartment (UR-002) but haven\'t heard back. Is there any update?', time: '1 day ago' },
            { sender: 'admin', name: 'Admin', text: 'Hello Jane, sorry for the delay. We are reviewing the report now. Can you confirm the license plate number?', time: '10 hours ago' },
            { sender: 'user', name: 'Jane Smith', text: 'I wrote it down in the report, but it was a black sedan, plate starting with "DHK-".', time: '8 hours ago' },
        ],
        'mike-johnson': [
            { sender: 'user', name: 'Mike Johnson', text: 'I saw a case of property damage (UR-003) earlier this morning. Is there a way to upload video evidence?', time: '5 hours ago' },
            { sender: 'admin', name: 'Admin', text: 'Yes, Mike. We can send you a secure link via email for upload. Please check your inbox shortly.', time: '4 hours ago' },
        ]
    };
    // --- End Mock Chat Messages ---
    
    // --- End Mock Data ---

    // Resolve API endpoints so dashboard works from FastAPI static hosting or Live Server.
    const API_BASE = window.location.origin.includes(':8000') ? '' : 'http://localhost:8000';

    function resolveApiUrl(path) {
      if (!path.startsWith('/')) {
        return `${API_BASE}/${path}`;
      }
      return `${API_BASE}${path}`;
    }

    function escapeHtml(value) {
      if (value === null || value === undefined) {
        return '';
      }
      const map = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#39;'
      };
      return value.toString().replace(/[&<>"']/g, (char) => map[char] || char);
    }

    function normalizeStatus(status) {
      const raw = (status || 'Pending').toString().trim();
      const normalized = raw.toLowerCase().replace(/_/g, ' ');
      const classMap = {
        'pending': 'status-pending',
        'reported': 'status-reported',
        'under investigation': 'status-under-investigation',
        'in progress': 'status-in-progress',
        'case closed': 'status-case-closed',
        'solved': 'status-resolved',
        'resolved': 'status-resolved',
        'verified': 'status-verified',
        'active': 'status-verified',
        'seen': 'status-verified',
        'unseen': 'status-reported',
        'found': 'status-verified',
        'missing': 'status-reported'
      };
      const className = classMap[normalized] || 'status-pending';
      const display = raw.replace(/_/g, ' ');
      return { className, display };
    }

    function formatCrimeLocation(locationData, fallback = {}) {
      if (typeof locationData === 'string' && locationData.trim()) {
        return locationData.trim();
      }

      if (locationData && typeof locationData === 'object') {
        const candidates = [
          locationData.area,
          locationData.area_name,
          locationData.neighborhood,
          locationData.town,
          locationData.city,
          locationData.district,
          locationData.address,
          locationData.address_line,
          locationData.formatted_address
        ].filter(part => typeof part === 'string' && part.trim());

        if (candidates.length) {
          const uniqueParts = Array.from(new Set(candidates.map(text => text.trim())));
          return uniqueParts.join(', ');
        }
      }

      const fallbackParts = [
        fallback.area,
        fallback.area_name,
        fallback.city,
        fallback.district
      ].filter(part => typeof part === 'string' && part.trim());

      return fallbackParts.join(', ') || 'N/A';
    }

    function renderCrimeRows(crimes, tbody) {
      tbody.innerHTML = '';
      if (!Array.isArray(crimes) || !crimes.length) {
        tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: var(--text-secondary);">No crime reports found.</td></tr>';
        return;
      }

      crimes.forEach(crime => {
        const locationText = formatCrimeLocation(crime.location_data, crime);
        const statusInfo = normalizeStatus(crime.status);
        const displayStatus = statusInfo.display
          .toLowerCase()
          .replace(/\b\w/g, char => char.toUpperCase());
        const numericId = crime.crime_id || crime.id || 0;
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>CR-${String(numericId).padStart(3, '0')}</td>
          <td>${locationText}</td>
          <td><span class="status-badge ${statusInfo.className}">${displayStatus}</span></td>
          <td>
            <button class="action-btn" onclick="viewCrimeDetails(${numericId})">
              <span>📄</span>
              Summarize
            </button>
          </td>
        `;
        tbody.appendChild(row);
      });
    }

    function parseMaybeJson(value) {
      if (!value) {
        return null;
      }
      if (typeof value === 'object') {
        return value;
      }
      if (typeof value === 'string') {
        try {
          return JSON.parse(value);
        } catch (error) {
          console.warn('Failed to parse JSON payload:', error);
          return null;
        }
      }
      return null;
    }

    function normalizeCrimeRecord(rawRecord) {
      if (!rawRecord || typeof rawRecord !== 'object') {
        return null;
      }
      const record = { ...rawRecord };
      const structuredFields = [
        'location_data',
        'crime_data',
        'victim_data',
        'criminal_data',
        'weapon_data',
        'witness_data',
        'evidence_files'
      ];

      structuredFields.forEach(field => {
        if (record[field] && typeof record[field] === 'string') {
          const parsed = parseMaybeJson(record[field]);
          if (parsed !== null) {
            record[field] = parsed;
          }
        }
      });

      return record;
    }

    function deriveReporterContact(record) {
      const candidateValues = [
        record?.crime_data?.reporter_contact,
        record?.victim_data?.phone,
        record?.victim_data?.email,
        record?.witness_data?.phone,
        record?.witness_data?.name,
        record?.reporter_id ? `Reporter ID ${record.reporter_id}` : null
      ];

      const primary = candidateValues.find(value => typeof value === 'string' && value.trim());
      return primary ? primary.trim() : 'Anonymous reporter';
    }

    function formatIncidentLocation(locationData) {
      if (!locationData || typeof locationData !== 'object') {
        return 'Unknown location';
      }

      const area = locationData.area_name || locationData.area || '';
      const city = locationData.city || '';
      const details = locationData.details || locationData.address || '';

      const summaryParts = [area, city].filter(Boolean).map(part => String(part).trim());
      const summary = summaryParts.length ? summaryParts.join(', ') : 'Location unspecified';

      if (details && String(details).trim()) {
        return `${summary} (${String(details).trim()})`;
      }

      return summary;
    }

    function coerceEvidenceList(value) {
      const parsed = Array.isArray(value) ? value : parseMaybeJson(value);
      return Array.isArray(parsed) ? parsed : [];
    }

    function renderComplaintsTable(records, tbody) {
      if (!Array.isArray(records) || !records.length) {
        tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: var(--text-secondary);">No reports are awaiting verification right now.</td></tr>';
        return;
      }

      tbody.innerHTML = '';

      records.forEach(record => {
        const complaintId = Number(record.crime_id);
        const displayId = Number.isFinite(complaintId) ? `COMP-${String(complaintId).padStart(3, '0')}` : 'COMP-???';
        const statusInfo = normalizeStatus(record.status || 'Pending');
        const statusKey = (record.status || 'Pending').toLowerCase();
        const isPending = statusKey === 'pending';
        const isVerified = statusKey === 'verified';

        const reporterContact = escapeHtml(deriveReporterContact(record));
        const reportedAt = escapeHtml(formatDateTimeDisplay(record.created_at));
        const statusBadge = `<span class="status-badge ${statusInfo.className}">${escapeHtml(statusInfo.display)}</span>`;

        const verifyDisabled = isPending ? '' : 'disabled';
        const rejectDisabled = isPending ? '' : 'disabled';
        const escalateDisabled = isVerified ? '' : 'disabled';
        const verifyTitle = isPending ? 'Mark report as verified' : 'Already verified';
        const rejectTitle = isPending ? 'Reject this report' : 'Only pending reports can be rejected';
        const escalateTitle = isVerified ? 'Escalate to case management' : 'Verify the report before escalating';

        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${escapeHtml(displayId)}</td>
          <td>${reporterContact}</td>
          <td>${reportedAt}</td>
          <td>${statusBadge}</td>
          <td>
            <button class="btn btn-success" title="${escapeHtml(verifyTitle)}" onclick="verifyComplaint(${complaintId})" ${verifyDisabled}>
              <span>✓</span>
              Verify
            </button>
            <button class="btn btn-danger" title="${escapeHtml(rejectTitle)}" onclick="rejectComplaint(${complaintId})" ${rejectDisabled}>
              <span>✗</span>
              Reject
            </button>
            <button class="btn btn-secondary" title="${escapeHtml(escalateTitle)}" onclick="escalateToCrime(${complaintId})" ${escalateDisabled}>
              <span>📋</span>
              Escalate to Crime
            </button>
            <button class="action-btn" onclick="viewComplaintDetails(${complaintId})">
              <span>👁️</span>
              View Details
            </button>
          </td>
        `;

        tbody.appendChild(row);
      });
    }

    function formatUserStatus(status) {
      const raw = (status || 'Unknown').toString().trim();
      const normalized = raw.toLowerCase();
      const classMap = {
        'active': 'status-verified',
        'inactive': 'status-pending',
        'suspended': 'status-under-investigation',
        'pending': 'status-pending',
        'banned': 'status-case-closed'
      };
      const className = classMap[normalized] || 'status-reported';
      const label = raw.replace(/_/g, ' ').toLowerCase().replace(/\b\w/g, c => c.toUpperCase());
      return { className, label };
    }

    function formatDateTimeDisplay(value) {
      if (!value) {
        return 'N/A';
      }
      try {
        const dt = new Date(value);
        if (Number.isNaN(dt.getTime())) {
          return value;
        }
        return dt.toLocaleString();
      } catch (err) {
        return value;
      }
    }

    function formatNumberDisplay(value) {
      const numeric = Number(value);
      if (Number.isFinite(numeric)) {
        return numeric.toLocaleString();
      }
      return value ?? 0;
    }

    function formatCurrencyBDT(value) {
      const numeric = Number(value);
      if (Number.isFinite(numeric)) {
        return `BDT ${numeric.toLocaleString()}`;
      }
      return 'BDT 0';
    }

    function formatDateOnly(value) {
      if (!value) {
        return 'N/A';
      }
      if (typeof value === 'string' && /^\d{4}-\d{2}-\d{2}$/.test(value.trim())) {
        const [year, month, day] = value.trim().split('-').map(Number);
        if ([year, month, day].every(num => Number.isFinite(num))) {
          const dt = new Date(Date.UTC(year, month - 1, day));
          return dt.toLocaleDateString(undefined, { year: 'numeric', month: 'short', day: 'numeric' });
        }
      }
      return formatDateTimeDisplay(value);
    }

    function formatTimeDisplay(value) {
      if (!value) {
        return 'N/A';
      }
      if (typeof value === 'string' && /^\d{2}:\d{2}(:\d{2})?$/.test(value.trim())) {
        const [hour, minute, second = '00'] = value.trim().split(':');
        const dt = new Date();
        dt.setHours(Number(hour), Number(minute), Number(second), 0);
        if (!Number.isNaN(dt.getTime())) {
          return dt.toLocaleTimeString(undefined, { hour: '2-digit', minute: '2-digit' });
        }
      }
      return value;
    }

    function formatGenderLabel(value) {
      if (!value) {
        return 'Unknown';
      }
      const normalized = value.toString().trim().toUpperCase();
      const labelMap = {
        'M': 'Male',
        'F': 'Female',
        'O': 'Other'
      };
      return labelMap[normalized] || value;
    }

    function formatAgeDisplay(value) {
      if (value === null || value === undefined || value === '') {
        return 'Unknown';
      }
      const numeric = Number(value);
      if (Number.isFinite(numeric) && numeric >= 0) {
        return numeric.toString();
      }
      return value;
    }

    if (criminalForm) {
      criminalForm.addEventListener('submit', async (event) => {
        event.preventDefault();

        const submitButton = criminalForm.querySelector('button[type="submit"]');
        const originalLabel = submitButton ? submitButton.innerHTML : '';
        if (submitButton) {
          submitButton.disabled = true;
          submitButton.innerHTML = '<span>⏳</span> Saving...';
        }

        const formData = new FormData(criminalForm);
        const sanitize = (value) => {
          if (value === null || value === undefined) {
            return null;
          }
          const trimmed = value.toString().trim();
          return trimmed.length ? trimmed : null;
        };
        const parseReward = (value) => {
          const numeric = Number(value);
          return Number.isFinite(numeric) && numeric >= 0 ? numeric : 0;
        };
        const crimesList = (formData.get('crimes_committed') ?? '')
          .toString()
          .split(/[\n,]+/)
          .map(item => item.trim())
          .filter(Boolean);

        const basePayload = {
          name: sanitize(formData.get('name')) || '',
          alias: sanitize(formData.get('alias')),
          age_range: sanitize(formData.get('age_range')) || '',
          gender: sanitize(formData.get('gender')) || '',
          description: sanitize(formData.get('description')) || '',
          height: sanitize(formData.get('height')),
          weight: sanitize(formData.get('weight')),
          hair_color: sanitize(formData.get('hair_color')),
          eye_color: sanitize(formData.get('eye_color')),
          distinguishing_marks: sanitize(formData.get('distinguishing_marks')),
          crimes_committed: crimesList.join(', '),
          reward_amount: parseReward(formData.get('reward_amount')),
          danger_level: sanitize(formData.get('danger_level')) || 'Medium',
          last_known_location: sanitize(formData.get('last_known_location'))
        };

        const missingFields = [];
        if (!basePayload.name) missingFields.push('Full Name');
        if (!basePayload.age_range) missingFields.push('Age Range');
        if (!basePayload.gender) missingFields.push('Gender');
        if (!basePayload.description) missingFields.push('Description');
        if (!basePayload.crimes_committed) missingFields.push('Crimes Committed');

        if (missingFields.length) {
          if (submitButton) {
            submitButton.disabled = false;
            submitButton.innerHTML = originalLabel;
          }
          showAlert(`Please fill out: ${missingFields.join(', ')}`);
          return;
        }

        try {
          let photoUrl = null;
          const photoFile = formData.get('photo_file');

          if (photoFile instanceof File && photoFile.size > 0) {
            if (photoFile.size > 5 * 1024 * 1024) {
              throw new Error('Image must be 5 MB or less.');
            }

            const uploadData = new FormData();
            uploadData.append('file', photoFile);

            const uploadResponse = await fetch(resolveApiUrl('/api/upload'), {
              method: 'POST',
              body: uploadData
            });

            if (!uploadResponse.ok) {
              const errorBody = await uploadResponse.json().catch(() => ({}));
              const detail = errorBody.detail || errorBody.message || `Upload failed with status ${uploadResponse.status}`;
              throw new Error(detail);
            }

            const uploadPayload = await uploadResponse.json().catch(() => ({}));
            photoUrl = uploadPayload.file_url || uploadPayload.url || null;

            if (!photoUrl) {
              throw new Error('Upload did not return a file URL.');
            }
          }

          const payload = {
            ...basePayload,
            photo_url: photoUrl,
            added_by: CURRENT_ADMIN_ID
          };

          const response = await fetch(resolveApiUrl('/api/admin/wanted-criminals'), {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(payload)
          });

          if (!response.ok) {
            const errorBody = await response.json().catch(() => ({}));
            const detail = errorBody.detail || errorBody.message || `Request failed with status ${response.status}`;
            throw new Error(detail);
          }

          await response.json().catch(() => ({}));

          showAlert('Wanted criminal added successfully.');
          criminalForm.reset();
          hideAddCriminalForm();
          await loadWantedCriminals();
        } catch (error) {
          console.error('Failed to add wanted criminal:', error);
          showAlert(`Unable to save wanted criminal: ${error.message}`);
        } finally {
          if (submitButton) {
            submitButton.disabled = false;
            submitButton.innerHTML = originalLabel;
          }
        }
      });
    }

    if (stationForm) {
      stationForm.addEventListener('submit', async (event) => {
        event.preventDefault();

        const submitButton = stationForm.querySelector('button[type="submit"]');
        const originalLabel = submitButton ? submitButton.innerHTML : '';
        if (submitButton) {
          submitButton.disabled = true;
          submitButton.innerHTML = '<span>⏳</span> Saving...';
        }

        const formData = new FormData(stationForm);
        const sanitize = (value) => {
          if (value === null || value === undefined) {
            return null;
          }
          const trimmed = value.toString().trim();
          return trimmed.length ? trimmed : null;
        };
        const parseCoordinate = (value) => {
          const numeric = Number(value);
          return Number.isFinite(numeric) ? numeric : null;
        };

        const payload = {
          station_name: sanitize(formData.get('station_name')) || '',
          station_code: sanitize(formData.get('station_code')) || '',
          address: sanitize(formData.get('address')),
          phone: sanitize(formData.get('phone')),
          email: sanitize(formData.get('email')),
          officer_in_charge: sanitize(formData.get('officer_in_charge')),
          latitude: parseCoordinate(formData.get('latitude')),
          longitude: parseCoordinate(formData.get('longitude')),
          jurisdiction_area: sanitize(formData.get('jurisdiction_area'))
        };

        const missing = [];
        if (!payload.station_name) missing.push('Station Name');
        if (!payload.station_code) missing.push('Station Code');

        const rangeErrors = [];
        if (payload.latitude !== null && (payload.latitude < -90 || payload.latitude > 90)) {
          rangeErrors.push('Latitude must be between -90 and 90 degrees');
        }
        if (payload.longitude !== null && (payload.longitude < -180 || payload.longitude > 180)) {
          rangeErrors.push('Longitude must be between -180 and 180 degrees');
        }

        if (missing.length || rangeErrors.length) {
          if (submitButton) {
            submitButton.disabled = false;
            submitButton.innerHTML = originalLabel;
          }
          const messageParts = [];
          if (missing.length) {
            messageParts.push(`Please complete: ${missing.join(', ')}`);
          }
          if (rangeErrors.length) {
            messageParts.push(rangeErrors.join('\n'));
          }
          showAlert(messageParts.join('\n\n'));
          return;
        }

        try {
          const response = await fetch(resolveApiUrl('/api/admin/police-stations'), {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(payload)
          });

          if (!response.ok) {
            const errorBody = await response.json().catch(() => ({}));
            const detail = errorBody.detail || errorBody.message || `Request failed with status ${response.status}`;
            throw new Error(detail);
          }

          showAlert('Police station added successfully.');
          hideAddStationForm();
          await loadPoliceStations();
        } catch (error) {
          console.error('Failed to add police station:', error);
          showAlert(error.message || 'Unable to add police station right now.');
        } finally {
          if (submitButton) {
            submitButton.disabled = false;
            submitButton.innerHTML = originalLabel;
          }
        }
      });
    }

    function formatDangerLevel(level) {
      const raw = (level || 'Unknown').toString().trim();
      const normalized = raw.toLowerCase();
      const classMap = {
        'low': 'danger-low',
        'medium': 'danger-medium',
        'high': 'danger-high',
        'extreme': 'danger-extreme'
      };
      const className = classMap[normalized] || 'danger-unknown';
      const label = raw.replace(/_/g, ' ').toLowerCase().replace(/\b\w/g, c => c.toUpperCase());
      return { className, label };
    }

    function buildCrimesSummary(value, maxItems = 3) {
      if (!value) {
        return 'N/A';
      }
      let items = [];
      if (Array.isArray(value)) {
        items = value;
      } else if (typeof value === 'string') {
        items = value.split(',');
      }
      const cleaned = items.map(item => item && item.toString().trim()).filter(Boolean);
      if (!cleaned.length) {
        return 'N/A';
      }
      if (cleaned.length <= maxItems) {
        return cleaned.join(', ');
      }
      const limited = cleaned.slice(0, maxItems).join(', ');
      return `${limited}...`;
    }

    function renderUserRows(users, tbody) {
      tbody.innerHTML = '';
      users.forEach(user => {
        const numericId = Number(user.user_id ?? user.id ?? 0);
        const validId = Number.isFinite(numericId) && numericId > 0 ? numericId : 0;
        const statusInfo = formatUserStatus(user.status);
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>USR-${String(validId || user.user_id || user.id || '000').padStart(3, '0')}</td>
          <td>${user.username || 'N/A'}</td>
          <td>${user.email || 'N/A'}</td>
          <td>${user.role_hint || 'User'}</td>
          <td>
            <span class="status-badge ${statusInfo.className}">${statusInfo.label}</span>
          </td>
          <td>${formatDateTimeDisplay(user.created_at)}</td>
          <td>
            <button class="action-btn" onclick="openUserActions(${validId})" ${validId === 0 ? 'disabled' : ''}>
              <span>⚙️</span>
              Manage
            </button>
          </td>
        `;
        tbody.appendChild(row);
      });
    }

    function renderWantedCriminalRows(criminals, tbody) {
      const dataset = Array.isArray(criminals) ? criminals : [];

      if (!dataset.length) {
        tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: var(--text-secondary);">No wanted criminals found.</td></tr>';
        return;
      }

      tbody.innerHTML = '';

      dataset.forEach(criminal => {
        const numericId = Number(criminal.criminal_id ?? criminal.id ?? 0);
        const validId = Number.isFinite(numericId) && numericId > 0 ? numericId : 0;
        const crimesSummary = buildCrimesSummary(criminal.crimes_committed, 3);
        const dangerInfo = formatDangerLevel(criminal.danger_level);
        const statusInfo = normalizeStatus(criminal.status);
        const rewardDisplay = formatCurrencyBDT(criminal.reward_amount);

        const row = document.createElement('tr');
        row.innerHTML = `
          <td>WNT-${String(validId || 0).padStart(3, '0')}</td>
          <td>${criminal.name || 'Unknown'}</td>
          <td>${criminal.alias || '&mdash;'}</td>
          <td title="${criminal.crimes_committed || crimesSummary}">${crimesSummary}</td>
          <td><span class="danger-badge ${dangerInfo.className}">${dangerInfo.label}</span></td>
          <td>${rewardDisplay}</td>
          <td><span class="status-badge ${statusInfo.className} status-clickable" data-criminal-id="${validId}">${statusInfo.display}</span></td>
          <td>
            ${validId > 0 ? `
              <button class="action-btn" onclick="viewWantedCriminal(${validId})">
                <span>👁️</span>
                View
              </button>
              <button class="action-btn" onclick="openWantedCriminalActions(${validId})">
                <span>⚙️</span>
                Manage
              </button>
            ` : '<span style="color: var(--text-secondary);">Unavailable</span>'}
          </td>
        `;
        tbody.appendChild(row);
      });
    }

    function renderPoliceStationRows(stations, tbody) {
      const dataset = Array.isArray(stations) ? stations : [];

      if (!dataset.length) {
        tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: var(--text-secondary);">No police stations found.</td></tr>';
        return;
      }

      tbody.innerHTML = '';

      dataset.forEach(record => {
        const stationId = Number(record.station_id ?? record.id);
        const displayId = Number.isFinite(stationId) ? `PS-${String(stationId).padStart(3, '0')}` : 'N/A';
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${escapeHtml(displayId)}</td>
          <td>${escapeHtml(record.station_name || 'Unknown')}</td>
          <td>${escapeHtml(record.station_code || '—')}</td>
          <td title="${escapeHtml(record.address || 'N/A')}">${escapeHtml((record.address || '').slice(0, 60) || 'N/A')}</td>
          <td>${escapeHtml(record.phone || record.email || 'N/A')}</td>
          <td>${escapeHtml(record.officer_in_charge || 'N/A')}</td>
          <td title="${escapeHtml(record.jurisdiction_area || 'N/A')}">${escapeHtml((record.jurisdiction_area || '').slice(0, 60) || 'N/A')}</td>
          <td>
            ${Number.isFinite(stationId)
              ? `<button class="action-btn" data-action="view-station" data-station-id="${stationId}"><span>👁️</span>View</button>`
              : '<span style="color: var(--text-secondary);">Unavailable</span>'}
          </td>
        `;
        tbody.appendChild(row);
      });
    }

    function renderMissingPersonRows(records, tbody) {
      const dataset = Array.isArray(records) ? records : [];

      if (!dataset.length) {
        tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; color: var(--text-secondary);">No missing person reports found.</td></tr>';
        return;
      }

      tbody.innerHTML = '';

      dataset.forEach(record => {
        const missingId = Number(record.missing_id ?? record.id);
        const displayId = Number.isFinite(missingId) ? `MISS-${String(missingId).padStart(4, '0')}` : 'N/A';
        const statusInfo = normalizeStatus(record.status || 'Missing');
        const hasFinderReport = Number.isFinite(missingId) && (record.status || '').toLowerCase() === 'found' && (
          record.finding_location || record.finder_name || record.finder_phone || record.finder_email || (
            record.still_with_finder !== undefined && record.still_with_finder !== null && record.still_with_finder !== ''
          )
        );
        const statusBadge = hasFinderReport
          ? `<button class="status-badge ${statusInfo.className} status-clickable" data-missing-id="${missingId}">${escapeHtml(statusInfo.display)}</button>`
          : `<span class="status-badge ${statusInfo.className}">${escapeHtml(statusInfo.display)}</span>`;
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${escapeHtml(displayId)}</td>
          <td>${escapeHtml(record.name || 'Unknown')}</td>
          <td>${escapeHtml(formatAgeDisplay(record.age))}</td>
          <td>${escapeHtml(formatGenderLabel(record.gender))}</td>
          <td title="${escapeHtml(record.last_seen_location || 'N/A')}">${escapeHtml((record.last_seen_location || '').slice(0, 60) || 'N/A')}</td>
          <td>${escapeHtml(formatDateOnly(record.last_seen_date))}</td>
          <td>${escapeHtml(record.contact_person || 'N/A')}</td>
          <td>${statusBadge}</td>
          <td>
            ${Number.isFinite(missingId)
              ? `<button class="action-btn" data-action="view-missing" data-missing-id="${missingId}"><span>👁️</span>View</button>`
              : '<span style="color: var(--text-secondary);">Unavailable</span>'}
          </td>
        `;
        tbody.appendChild(row);
      });
    }

    function viewPoliceStation(stationId) {
      const numericId = Number(stationId);
      if (!Number.isFinite(numericId) || !policeStationCache.has(numericId)) {
        showAlert('Station details are not available right now.');
        return;
      }

      const record = policeStationCache.get(numericId);
      const displayId = `PS-${String(numericId).padStart(3, '0')}`;
      const details = [
        `Station: ${displayId}`,
        `Name: ${record.station_name || 'Unknown'}`,
        `Code: ${record.station_code || '—'}`,
        `Phone: ${record.phone || 'N/A'}`,
        `Email: ${record.email || 'N/A'}`,
        `Officer in Charge: ${record.officer_in_charge || 'N/A'}`,
        `Address: ${record.address || 'N/A'}`,
        `Jurisdiction: ${record.jurisdiction_area || 'N/A'}`,
        `Coordinates: ${record.latitude ?? '—'}, ${record.longitude ?? '—'}`,
        `Created At: ${formatDateTimeDisplay(record.created_at)}`,
        `Last Updated: ${formatDateTimeDisplay(record.updated_at || record.created_at)}`
      ];

      showAlert(details.join('\n'));
    }

    function viewMissingPerson(missingId) {
      const numericId = Number(missingId);
      if (!Number.isFinite(numericId) || !missingPersonsCache.has(numericId)) {
        showAlert('Missing person details are unavailable right now.');
        return;
      }

      const record = missingPersonsCache.get(numericId);
      const displayId = `MISS-${String(numericId).padStart(4, '0')}`;
      const statusInfo = normalizeStatus(record.status || 'Missing');
      const ageDisplay = formatAgeDisplay(record.age);
      const lastSeenDate = formatDateOnly(record.last_seen_date);
      const lastSeenTime = formatTimeDisplay(record.last_seen_time);
      const lastSeenLocation = record.last_seen_location || 'Unknown';
      const contactDisplay = [record.contact_person, record.contact_phone].filter(Boolean).join(' · ') || 'N/A';

      const caseSummaryItems = [
        `<li><strong>Case ID:</strong> ${escapeHtml(displayId)}</li>`,
        `<li><strong>Status:</strong> <span class="status-badge ${statusInfo.className}">${escapeHtml(statusInfo.display)}</span></li>`,
        `<li><strong>Last Seen:</strong> ${escapeHtml(lastSeenDate)} at ${escapeHtml(lastSeenTime)}</li>`,
        `<li><strong>Location:</strong> ${escapeHtml(lastSeenLocation)}</li>`,
        `<li><strong>Contact:</strong> ${escapeHtml(contactDisplay)}</li>`,
        `<li><strong>Police Case #:</strong> ${escapeHtml(record.police_case_number || 'N/A')}</li>`
      ].join('');

      let finderStatusRaw = '';
      if (record.still_with_finder !== undefined && record.still_with_finder !== null) {
        if (typeof record.still_with_finder === 'string') {
          finderStatusRaw = record.still_with_finder;
        } else {
          finderStatusRaw = record.still_with_finder ? 'Yes' : 'No';
        }
      }
      const finderItems = [
        record.finding_location ? `<li><strong>Finding Location:</strong> ${escapeHtml(record.finding_location)}</li>` : null,
        record.finder_name ? `<li><strong>Finder Name:</strong> ${escapeHtml(record.finder_name)}</li>` : null,
        record.finder_phone ? `<li><strong>Finder Phone:</strong> ${escapeHtml(record.finder_phone)}</li>` : null,
        record.finder_email ? `<li><strong>Finder Email:</strong> ${escapeHtml(record.finder_email)}</li>` : null,
        finderStatusRaw ? `<li><strong>Still With Finder:</strong> ${escapeHtml(finderStatusRaw)}</li>` : null,
        record.updated_at ? `<li><strong>Last Updated:</strong> ${escapeHtml(formatDateTimeDisplay(record.updated_at))}</li>` : null
      ].filter(Boolean).join('');

      const appearanceItems = [
        record.height ? `<li><strong>Height:</strong> ${escapeHtml(record.height)}</li>` : null,
        record.weight ? `<li><strong>Weight:</strong> ${escapeHtml(record.weight)}</li>` : null,
        record.hair_color ? `<li><strong>Hair:</strong> ${escapeHtml(record.hair_color)}</li>` : null,
        record.eye_color ? `<li><strong>Eyes:</strong> ${escapeHtml(record.eye_color)}</li>` : null,
        record.distinguishing_marks ? `<li><strong>Marks:</strong> ${escapeHtml(record.distinguishing_marks)}</li>` : null,
        record.clothing_description ? `<li><strong>Clothing:</strong> ${escapeHtml(record.clothing_description)}</li>` : null
      ].filter(Boolean).join('');

      const demographicsItems = [
        `<li><strong>Name:</strong> ${escapeHtml(record.name || 'Unknown')}</li>`,
        `<li><strong>Age:</strong> ${escapeHtml(ageDisplay)}</li>`,
        `<li><strong>Gender:</strong> ${escapeHtml(formatGenderLabel(record.gender))}</li>`
      ].join('');

      const demographicsBlock = `
        <div class="stats-insights">
          <h4>Demographics</h4>
          <ul>${demographicsItems}</ul>
        </div>
      `;

      const caseSummaryBlock = `
        <div class="stats-insights">
          <h4>Case Summary</h4>
          <ul>${caseSummaryItems}</ul>
        </div>
      `;

      const appearanceBlock = appearanceItems
        ? `<div class="stats-insights"><h4>Appearance</h4><ul>${appearanceItems}</ul></div>`
        : '';

      const descriptionBlock = record.description
        ? `<div class="stats-insights missing-description"><h4>Description</h4><p>${escapeHtml(record.description)}</p></div>`
        : '';

      const finderBlock = finderItems
        ? `<div class="stats-insights"><h4>Finder Report</h4><ul>${finderItems}</ul></div>`
        : '';

      const photoSection = record.photo_url
        ? `<div class="missing-photo-card"><img src="${escapeHtml(record.photo_url)}" alt="${escapeHtml(record.name || 'Missing person photo')}" /></div>`
        : `<div class="missing-photo-card missing-photo-placeholder">No photo available</div>`;

      modalContainer.classList.add('modal-wide');

      modalMessage.innerHTML = `
        <div class="missing-modal">
          <div class="missing-header">
            <h3>${escapeHtml(record.name || 'Unknown')}</h3>
            <p>Report submitted on ${escapeHtml(formatDateTimeDisplay(record.created_at))}</p>
          </div>
          <div class="missing-body">
            <div class="missing-details">
              ${demographicsBlock}
              ${caseSummaryBlock}
              ${finderBlock}
              ${appearanceBlock}
              ${descriptionBlock}
            </div>
            <div class="missing-sidebar">
              ${photoSection}
            </div>
          </div>
        </div>
      `;

      modalButtons.innerHTML = '';
      modalButtons.classList.remove('stacked');

      const closeButton = document.createElement('button');
      closeButton.className = 'btn btn-primary';
      closeButton.textContent = 'Close';
      closeButton.onclick = () => closeModal();
      const removeButton = document.createElement('button');
      removeButton.className = 'btn btn-danger';
      removeButton.textContent = 'Remove Report';
      removeButton.onclick = () => {
        closeModal();
        showConfirm(`Remove ${escapeHtml(record.name || displayId)} from missing persons?`, async (confirmed) => {
          if (!confirmed) {
            viewMissingPerson(numericId);
            return;
          }
          await deleteMissingPerson(numericId);
        });
      };
      modalButtons.appendChild(removeButton);
      modalButtons.appendChild(closeButton);

      modalOverlay.classList.add('show');
    }

    async function deleteMissingPerson(missingId) {
      const numericId = Number(missingId);
      if (!Number.isFinite(numericId) || numericId <= 0) {
        showAlert('Invalid missing person reference.');
        return;
      }

      try {
        const response = await fetch(resolveApiUrl(`/api/missing-persons/${numericId}`), {
          method: 'DELETE'
        });

        const payload = await response.json().catch(() => ({}));

        if (!response.ok) {
          const message = payload.detail || payload.message || `Failed to remove record (status ${response.status}).`;
          throw new Error(message);
        }

        missingPersonsCache.delete(numericId);
        await loadMissingPersons();
        showAlert('Missing person report removed successfully.');
      } catch (error) {
        console.error('Failed to delete missing person:', error);
        showAlert(`Unable to remove report: ${error.message || 'Unknown error'}`);
      }
    }

    function showMissingPersonFinder(missingId) {
      const numericId = Number(missingId);
      if (!Number.isFinite(numericId) || !missingPersonsCache.has(numericId)) {
        showAlert('Finder report is not available for this case.');
        return;
      }

      const record = missingPersonsCache.get(numericId);
      const caseLabel = `MISS-${String(numericId).padStart(4, '0')}`;
      let stillWithFinder = '';
      if (record.still_with_finder !== undefined && record.still_with_finder !== null) {
        if (typeof record.still_with_finder === 'string') {
          stillWithFinder = record.still_with_finder;
        } else {
          stillWithFinder = record.still_with_finder ? 'Yes' : 'No';
        }
      }

      const finderEntries = [
        record.finding_location ? `<li><strong>Finding Location:</strong> ${escapeHtml(record.finding_location)}</li>` : null,
        record.finder_name ? `<li><strong>Finder Name:</strong> ${escapeHtml(record.finder_name)}</li>` : null,
        record.finder_phone ? `<li><strong>Finder Phone:</strong> ${escapeHtml(record.finder_phone)}</li>` : null,
        record.finder_email ? `<li><strong>Finder Email:</strong> ${escapeHtml(record.finder_email)}</li>` : null,
        stillWithFinder ? `<li><strong>Still With Finder:</strong> ${escapeHtml(stillWithFinder)}</li>` : null,
        record.updated_at ? `<li><strong>Last Updated:</strong> ${escapeHtml(formatDateTimeDisplay(record.updated_at))}</li>` : null
      ].filter(Boolean);

      if (!finderEntries.length) {
        showAlert('Finder details have not been recorded yet.');
        return;
      }

      modalContainer.classList.remove('modal-wide');
      modalMessage.innerHTML = `
        <div class="stats-modal">
          <div class="stats-header">
            <h3>Finder Report</h3>
            <p>${escapeHtml(record.name || 'Unknown person')} · Case ${escapeHtml(caseLabel)}</p>
          </div>
          <div class="stats-insights">
            <h4>Details</h4>
            <ul>${finderEntries.join('')}</ul>
          </div>
        </div>
      `;

      modalButtons.innerHTML = '';
      modalButtons.classList.remove('stacked');

      const viewButton = document.createElement('button');
      viewButton.className = 'btn btn-secondary';
      viewButton.textContent = 'View Full Report';
      viewButton.onclick = () => {
        closeModal();
        viewMissingPerson(numericId);
      };

      const closeButton = document.createElement('button');
      closeButton.className = 'btn btn-primary';
      closeButton.textContent = 'Close';
      closeButton.onclick = () => closeModal();

      modalButtons.appendChild(viewButton);
      modalButtons.appendChild(closeButton);
      modalOverlay.classList.add('show');
    }

    async function getWantedCriminalRecord(criminalId, options = {}) {
      const { forceRefresh = false } = options;
      const numericId = Number(criminalId);
      if (!Number.isFinite(numericId) || numericId <= 0) {
        return null;
      }

      if (!forceRefresh && wantedCriminalCache.has(numericId)) {
        return wantedCriminalCache.get(numericId);
      }

      try {
        const response = await fetch(resolveApiUrl(`/api/wanted-criminals/${numericId}`), { cache: 'no-store' });
        if (!response.ok) {
          throw new Error(`Request failed with status ${response.status}`);
        }
        const payload = await response.json().catch(() => ({}));
        const record = payload.wanted_criminal || payload;
        if (record) {
          wantedCriminalCache.set(numericId, record);
          return record;
        }
        return null;
      } catch (error) {
        console.error('Error fetching wanted criminal:', error);
        throw error instanceof Error ? error : new Error('Failed to load wanted criminal.');
      }
    }

    async function viewWantedCriminal(criminalId) {
      const numericId = Number(criminalId);
      if (!Number.isFinite(numericId) || numericId <= 0) {
        showAlert('Unable to load criminal details right now.');
        return;
      }

      let record;
      try {
        record = await getWantedCriminalRecord(numericId);
      } catch (error) {
        showAlert('Unable to fetch criminal details at this time.');
        return;
      }

      if (!record) {
        showAlert('Criminal record not found.');
        return;
      }

      const displayId = `WNT-${String(numericId).padStart(3, '0')}`;
      const dangerInfo = formatDangerLevel(record.danger_level);
      const statusInfo = normalizeStatus(record.status);
      const rewardDisplay = formatCurrencyBDT(record.reward_amount);
      const crimesDetail = Array.isArray(record.crimes_committed)
        ? record.crimes_committed.join(', ')
        : (record.crimes_committed || 'N/A');
      const locationDetail = record.last_known_location || 'Unknown';
      const lastReportedLocation = record.last_seen_reported_location || locationDetail;
      const lastReportedAt = formatDateTimeDisplay(record.last_seen_reported_at);
      const lastReportedFinder = (record.last_seen_with_finder || 'No').toString();
      const wantedSinceDisplay = formatDateTimeDisplay(record.wanted_since);
      const captureDateDisplay = formatDateTimeDisplay(record.capture_date);
      const updatedDisplay = formatDateTimeDisplay(record.updated_at || record.created_at);

      const details = [
        `Record: ${displayId}`,
        `Name: ${record.name || 'N/A'}`,
        `Alias: ${record.alias || 'N/A'}`,
        `Danger Level: ${dangerInfo.label}`,
        `Status: ${statusInfo.display}`,
        `Crimes: ${crimesDetail}`,
        `Reward: ${rewardDisplay}`,
        `Age Range: ${record.age_range || 'N/A'}`,
        `Gender: ${record.gender || 'N/A'}`,
        `Height: ${record.height || 'N/A'}`,
        `Weight: ${record.weight || 'N/A'}`,
        `Distinguishing Marks: ${record.distinguishing_marks || 'N/A'}`,
        `Last Known Location: ${locationDetail}`,
        `Last Reported Location: ${lastReportedLocation}`,
        `Last Reported At: ${lastReportedAt}`,
        `With Finder: ${lastReportedFinder}`,
        `Wanted Since: ${wantedSinceDisplay}`,
        `Capture Date: ${captureDateDisplay}`,
        `Reported By: ${record.added_by || 'N/A'}`,
        `Last Updated: ${updatedDisplay}`
      ];

      if (record.description) {
        details.push('', 'Description:', record.description);
      }

      showAlert(details.join('\n'));
    }

    async function openWantedCriminalActions(criminalId) {
      const numericId = Number(criminalId);
      if (!Number.isFinite(numericId) || numericId <= 0) {
        showAlert('No management actions available.');
        return;
      }

      let record;
      try {
        record = await getWantedCriminalRecord(numericId);
      } catch (error) {
        showAlert('Unable to load management tools right now.');
        return;
      }

      if (!record) {
        showAlert('Criminal record not found.');
        return;
      }

      const displayId = `WNT-${String(numericId).padStart(3, '0')}`;
      const statusInfo = normalizeStatus(record.status);
      const dangerInfo = formatDangerLevel(record.danger_level);

      modalMessage.innerHTML = `
        <div style="display:flex;flex-direction:column;gap:0.6rem;">
          <div>
            <strong>${escapeHtml(displayId)} · ${escapeHtml(record.name || 'Unknown')}</strong>
            ${record.alias ? `<div style="color: var(--text-secondary); font-size: 0.88rem;">Alias: ${escapeHtml(record.alias)}</div>` : ''}
          </div>
          <div style="display:flex;flex-direction:column;gap:0.35rem;font-size:0.88rem;color:var(--text-secondary);">
            <div>Status: <span class="status-badge ${statusInfo.className}" style="font-size:0.7rem;">${escapeHtml(statusInfo.display)}</span></div>
            <div>Danger Level: <span class="danger-badge ${dangerInfo.className}" style="font-size:0.7rem;">${escapeHtml(dangerInfo.label)}</span></div>
          </div>
          <p style="margin:0;font-size:0.9rem;color:var(--text-secondary);">
            Remove this person from the active wanted list once they have been apprehended.
          </p>
        </div>
      `;

      modalButtons.innerHTML = '';
      modalButtons.classList.add('stacked');

      const markButton = document.createElement('button');
      markButton.className = 'btn btn-danger';
      markButton.textContent = 'Remove from Wanted List';
      markButton.onclick = async () => {
        const originalLabel = markButton.textContent;
        markButton.disabled = true;
        markButton.textContent = 'Removing...';
        try {
          await removeWantedCriminal(numericId);
          closeModal();
          showAlert(`${displayId} removed from the wanted list.`);
        } catch (error) {
          console.error('Failed to remove wanted criminal:', error);
          markButton.disabled = false;
          markButton.textContent = originalLabel;
          closeModal();
          showAlert(`Unable to update record: ${error.message}`);
        }
      };

      const cancelButton = document.createElement('button');
      cancelButton.className = 'btn btn-secondary';
      cancelButton.textContent = 'Cancel';
      cancelButton.onclick = () => closeModal();

      modalButtons.appendChild(markButton);
      modalButtons.appendChild(cancelButton);
      modalOverlay.classList.add('show');
    }

    async function fetchCriminalSightings(criminalId) {
      const response = await fetch(resolveApiUrl(`/api/wanted-criminals/${criminalId}/sightings`), { cache: 'no-store' });
      if (!response.ok) {
        throw new Error(`Request failed with status ${response.status}`);
      }
      const payload = await response.json().catch(() => ({}));
      const records = Array.isArray(payload) ? payload : (payload.sightings || []);
      return records.map(item => ({
        sighting_id: item.sighting_id,
        criminal_id: item.criminal_id,
        last_seen_time: item.last_seen_time || null,
        last_seen_location: item.last_seen_location || null,
        still_with_finder: Boolean(item.still_with_finder),
        reporter_contact: item.reporter_contact || null,
        created_at: item.created_at || null
      }));
    }

    async function showSightingHistory(criminalId) {
      const numericId = Number(criminalId);
      if (!Number.isFinite(numericId) || numericId <= 0) {
        showAlert('No sighting data available for this record.');
        return;
      }

      let baseRecord = null;
      try {
        baseRecord = await getWantedCriminalRecord(numericId);
      } catch (error) {
        console.warn('Unable to resolve base record for sighting history:', error);
      }

      let sightings;
      try {
        sightings = await fetchCriminalSightings(numericId);
      } catch (error) {
        console.error('Failed to load sighting history:', error);
        showAlert('Unable to load sighting history right now.');
        return;
      }

      const displayId = `WNT-${String(numericId).padStart(3, '0')}`;
      const headerName = baseRecord ? (baseRecord.name || 'Unknown') : 'Unknown';

      const historyMarkup = sightings.length
        ? sightings.map(entry => {
            const reportedAt = formatDateTimeDisplay(entry.last_seen_time || entry.created_at);
            const loggedAt = formatDateTimeDisplay(entry.created_at);
            const locationText = escapeHtml(entry.last_seen_location || 'Unknown');
            const finderText = entry.still_with_finder ? 'Yes' : 'No';
            const contactText = entry.reporter_contact ? `<div class="sighting-meta">Contact: ${escapeHtml(entry.reporter_contact)}</div>` : '';
            const loggedMeta = loggedAt && loggedAt !== reportedAt
              ? ` · Logged: ${loggedAt}`
              : '';
            return `
              <li>
                <div><strong>${escapeHtml(reportedAt)}</strong></div>
                <div>${locationText}</div>
                <div class="sighting-meta">With finder: ${finderText}${loggedMeta}</div>
                ${contactText}
              </li>
            `;
          }).join('')
        : '<li>No sightings have been reported yet.</li>';

      modalMessage.innerHTML = `
        <div style="display:flex;flex-direction:column;gap:0.75rem;">
          <div>
            <strong>${escapeHtml(displayId)} sighting history</strong>
            <div style="color: var(--text-secondary); font-size: 0.88rem;">${escapeHtml(headerName)}</div>
          </div>
          <p style="margin:0;color:var(--text-secondary);font-size:0.85rem;">
            Every submitted last seen report appears below. The newest entries show first.
          </p>
          <ul class="sightings-history">
            ${historyMarkup}
          </ul>
        </div>
      `;

      modalButtons.innerHTML = '';
      modalButtons.classList.remove('stacked');

      const closeButton = document.createElement('button');
      closeButton.className = 'btn btn-primary';
      closeButton.textContent = 'Close';
      closeButton.onclick = () => closeModal();

      modalButtons.appendChild(closeButton);
      modalOverlay.classList.add('show');
    }

    async function removeWantedCriminal(criminalId) {
      const numericId = Number(criminalId);
      if (!Number.isFinite(numericId) || numericId <= 0) {
        throw new Error('Invalid criminal reference.');
      }

      try {
        const response = await fetch(resolveApiUrl(`/api/admin/wanted-criminals/${numericId}`), {
          method: 'DELETE'
        });

        if (!response.ok) {
          const errorBody = await response.json().catch(() => ({}));
          const detail = errorBody.detail || errorBody.message || `Request failed with status ${response.status}`;
          throw new Error(detail);
        }

        wantedCriminalCache.delete(numericId);
        await loadWantedCriminals();
      } catch (error) {
        console.error('Failed to remove wanted criminal:', error);
        if (error instanceof Error) {
          throw error;
        }
        throw new Error('Failed to remove wanted criminal.');
      }
    }

    function generateChartColors(count) {
      const colors = [];
      for (let i = 0; i < count; i += 1) {
        colors.push(CHART_COLOR_PALETTE[i % CHART_COLOR_PALETTE.length]);
      }
      return colors;
    }

    function renderDoughnutChart(canvasId, labels, data, chartKey) {
      if (typeof Chart === 'undefined') {
        return;
      }

      const canvas = document.getElementById(canvasId);
      if (!canvas) {
        return;
      }

      if (chartInstances[chartKey]) {
        chartInstances[chartKey].destroy();
      }

      const total = data.reduce((sum, value) => sum + value, 0);
      const backgroundColor = generateChartColors(labels.length);

      chartInstances[chartKey] = new Chart(canvas, {
        type: 'doughnut',
        data: {
          labels,
          datasets: [
            {
              data,
              backgroundColor,
              borderWidth: 1,
              borderColor: 'rgba(26, 26, 26, 0.95)',
              hoverBorderColor: '#ffffff',
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          cutout: '58%',
          radius: '92%',
          plugins: {
            legend: {
              position: 'bottom',
              labels: {
                color: '#f3f4f6',
                usePointStyle: true,
                padding: 16,
                font: {
                  size: 12,
                  family: 'Inter, Arial, sans-serif'
                }
              }
            },
            tooltip: {
              callbacks: {
                label(context) {
                  const label = context.label || 'Unknown';
                  const value = Number(context.parsed) || 0;
                  const share = total ? ((value / total) * 100).toFixed(1) : 0;
                  return `${label}: ${value} (${share}%)`;
                }
              }
            },
            title: {
              display: false
            }
          },
          animation: {
            duration: 600,
            easing: 'easeOutQuart'
          }
        }
      });
    }


    // Tab switching functionality
    function showTab(tabName, event) {
      // Hide all tab contents
      const tabContents = document.querySelectorAll('.tab-content');
      tabContents.forEach(content => content.classList.remove('active'));
      
      // Remove active class from all tab buttons
      const tabButtons = document.querySelectorAll('.tab-btn');
      tabButtons.forEach(btn => btn.classList.remove('active'));
      
      // Show selected tab content
      document.getElementById(tabName).classList.add('active');
      
      // Add active class to clicked button
      if (event && event.target) {
         event.target.closest('.tab-btn').classList.add('active');
      } else {
        // Fallback for programmatic calls
        document.querySelector(`.tab-btn[onclick*="'${tabName}'"]`).classList.add('active');
      }
      
      // Load data for specific tabs (uses local mock data)
      if (tabName === 'overview') {
        loadCrimesOverview();
      } else if (tabName === 'users') {
        loadUsers();
      } else if (tabName === 'wanted-criminals') {
        loadWantedCriminals();
      } else if (tabName === 'police-stations') {
        loadPoliceStations();
      } else if (tabName === 'missing-persons') {
        loadMissingPersons();
      } else if (tabName === 'verify-reports') {
        loadComplaints();
      } else if (tabName === 'case-management') {
        loadCaseAssignments();
      } else if (tabName === 'analytics') {
        loadAnalytics();
      }
      // Auto-scroll chat when opening chat tab
      if (tabName === 'chat') {
        // Ensure the initial chat (John Doe) is selected and loaded
        selectUser('john-doe'); 
      }
    }

    // Add crime form submission
    document.getElementById('add-crime-form').addEventListener('submit', async function(e) {
      e.preventDefault();
      const formData = new FormData(this);
      const crimeData = Object.fromEntries(formData);

      const toNumberOrNull = (value) => {
        if (value === null || value === undefined) {
          return null;
        }
        const normalized = value.toString().trim();
        if (!normalized) {
          return null;
        }
        const numeric = Number(normalized);
        return Number.isFinite(numeric) ? numeric : null;
      };

      const buildCleanObject = (candidate) => {
        const result = {};
        Object.entries(candidate).forEach(([key, value]) => {
          if (value === null || value === undefined) {
            return;
          }
          if (typeof value === 'string') {
            const trimmed = value.trim();
            if (!trimmed) {
              return;
            }
            result[key] = trimmed;
            return;
          }
          if (Array.isArray(value)) {
            if (value.length) {
              result[key] = value;
            }
            return;
          }
          if (typeof value === 'number' && Number.isFinite(value)) {
            result[key] = value;
            return;
          }
          if (typeof value === 'boolean') {
            result[key] = value;
          }
        });
        return Object.keys(result).length ? result : null;
      };

      const payload = {
        crime_type: (crimeData.crime_type || '').trim(),
        status: (crimeData.status || '').trim(),
        city: (crimeData.city || '').trim(),
        area_name: (crimeData.area_name || '').trim(),
        location_details: (crimeData.location_details || '').trim() || null,
        incident_time: (crimeData.incident_time || '').trim() || null,
        priority: (crimeData.priority || 'medium').trim(),
        description: (crimeData.description || '').trim(),
        reporter_id: Number.isFinite(CURRENT_ADMIN_ID) ? CURRENT_ADMIN_ID : null
      };

      const victim = buildCleanObject({
        name: crimeData.victim_name,
        age: toNumberOrNull(crimeData.victim_age),
        gender: crimeData.victim_gender,
        contact: crimeData.victim_contact,
        notes: crimeData.victim_notes
      });
      if (victim) {
        payload.victim = victim;
      }

      const criminal = buildCleanObject({
        name: crimeData.criminal_name,
        alias: crimeData.criminal_alias,
        description: crimeData.criminal_description,
        last_known_location: crimeData.criminal_last_known
      });
      if (criminal) {
        payload.criminal = criminal;
      }

      const weapon = buildCleanObject({
        type: crimeData.weapon_type,
        description: crimeData.weapon_description,
        recovered_status: crimeData.weapon_recovered
      });
      if (weapon) {
        payload.weapon = weapon;
      }

      let witness = buildCleanObject({
        name: crimeData.witness_name,
        contact: crimeData.witness_contact
      });

      const witnessStatement = (crimeData.witness_statement || '').trim();
      if (witnessStatement) {
        if (!witness) {
          witness = {};
        }
        witness.statement = witnessStatement;
        payload.witness = witness;
        payload.witness_info = witnessStatement;
      } else if (witness) {
        payload.witness = witness;
      }

      const evidenceFiles = formData.getAll('evidence_files').filter(item => item instanceof File && item.size > 0);

      if (!payload.crime_type || !payload.status || !payload.city || !payload.area_name || !payload.incident_time || !payload.description) {
        showAlert('Please fill in all required fields before submitting the crime report.');
        return;
      }

      const submitBtn = this.querySelector('button[type="submit"]');
      const originalText = submitBtn ? submitBtn.innerHTML : '';

      try {
        if (submitBtn) {
          submitBtn.innerHTML = '<span>⏳</span> Adding Crime...';
          submitBtn.disabled = true;
        }

        if (evidenceFiles.length) {
          const uploadedEvidence = [];
          for (const file of evidenceFiles) {
            if (file.size > 5 * 1024 * 1024) {
              throw new Error(`Evidence file "${file.name}" is larger than 5 MB.`);
            }

            const uploadData = new FormData();
            uploadData.append('file', file);

            const uploadResponse = await fetch(resolveApiUrl('/api/upload'), {
              method: 'POST',
              body: uploadData
            });

            if (!uploadResponse.ok) {
              const uploadError = await uploadResponse.json().catch(() => ({}));
              const detail = uploadError.detail || uploadError.message || `Upload failed with status ${uploadResponse.status}`;
              throw new Error(detail);
            }

            const uploadResult = await uploadResponse.json().catch(() => ({}));
            const fileUrl = uploadResult.file_url || uploadResult.url;
            if (!fileUrl) {
              throw new Error('Upload failed: server did not return a file URL.');
            }

            uploadedEvidence.push({
              url: fileUrl,
              stored_name: uploadResult.filename || uploadResult.name || null,
              original_name: file.name,
              mime_type: file.type || null,
              size_bytes: file.size
            });
          }

          if (uploadedEvidence.length) {
            payload.evidence_files = uploadedEvidence;
          }
        }

        const response = await fetch(resolveApiUrl('/api/admin/crimes'), {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(payload)
        });

        const result = await response.json().catch(() => ({}));

        if (!response.ok) {
          const message = result.detail || result.message || 'Failed to add crime report.';
          throw new Error(message);
        }

        const newCrimeId = Number(result.crime_id);
        const crimeCode = Number.isFinite(newCrimeId) ? `CR-${String(newCrimeId).padStart(3, '0')}` : 'New Crime';

        showAlert(`Crime added successfully!\nCrime ID: ${crimeCode}`);
        this.reset();
        loadCrimesOverview();
      } catch (error) {
        console.error('Error:', error);
        showAlert(`Error adding crime: ${error.message}`);
      } finally {
        if (submitBtn) {
          submitBtn.innerHTML = originalText;
          submitBtn.disabled = false;
        }
      }
    });

    // Load crimes for overview tab
    async function loadCrimesOverview() {
      const tbody = document.getElementById('crimes-table');
      if (!tbody) {
        return;
      }

      tbody.innerHTML = '<tr><td colspan="4" style="text-align: center;">Loading crime reports...</td></tr>';

      try {
        const response = await fetch(resolveApiUrl('/api/crimes?limit=25'), { cache: 'no-store' });
        if (!response.ok) {
          throw new Error(`Request failed with status ${response.status}`);
        }

        const payload = await response.json().catch(() => ({}));
        const crimes = Array.isArray(payload.crimes) ? payload.crimes : [];

        if (crimes.length === 0) {
          tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: var(--text-secondary);">No crime reports found.</td></tr>';
          return;
        }

        renderCrimeRows(crimes, tbody);
      } catch (error) {
        console.error('Error loading crimes from API:', error);
        tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: var(--accent-red);">Unable to load crime reports right now.</td></tr>';
      }
    }

    // Load complaints for verify reports tab
    async function loadComplaints() {
      const tbody = document.getElementById('complaints-table');
      if (!tbody) {
        return;
      }

      tbody.innerHTML = '<tr><td colspan="5" style="text-align: center;">Loading reports…</td></tr>';

      try {
        const response = await fetch(resolveApiUrl('/api/crimes?limit=200'), { cache: 'no-store' });
        if (!response.ok) {
          throw new Error(`Request failed with status ${response.status}`);
        }

        const payload = await response.json().catch(() => ({}));
        const fetchedRecords = Array.isArray(payload.crimes) ? payload.crimes : [];

        const normalized = fetchedRecords
          .map(normalizeCrimeRecord)
          .filter(record => record && Number.isFinite(Number(record.crime_id)));

        const relevantStatuses = new Set(['pending', 'verified']);
        const filtered = normalized.filter(record => relevantStatuses.has((record.status || 'Pending').toLowerCase()));

        filtered.sort((a, b) => {
          const statusPriority = status => {
            const key = (status || 'Pending').toLowerCase();
            if (key === 'pending') return 0;
            if (key === 'verified') return 1;
            return 2;
          };
          const priorityDiff = statusPriority(a.status) - statusPriority(b.status);
          if (priorityDiff !== 0) {
            return priorityDiff;
          }
          const aDate = new Date(a.updated_at || a.created_at || 0).getTime();
          const bDate = new Date(b.updated_at || b.created_at || 0).getTime();
          return bDate - aDate;
        });

        complaintsList = filtered;
        complaintsCache.clear();
        filtered.forEach(record => {
          const id = Number(record.crime_id);
          if (Number.isFinite(id)) {
            complaintsCache.set(id, record);
          }
        });

        renderComplaintsTable(filtered, tbody);
      } catch (error) {
        console.error('Error loading complaints:', error);
        tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: var(--accent-red);">Unable to load reports right now. Please try again shortly.</td></tr>';
      }
    }

    // Load case assignments
    async function loadCaseAssignments() {
      const tbody = document.getElementById('assignments-table');
      tbody.innerHTML = '<tr><td colspan="7" style="text-align: center;">Loading case assignments...</td></tr>';
      try {
        // --- MOCK DATA SIMULATION ---
        await new Promise(resolve => setTimeout(resolve, 300)); 
        const result = { success: true, assignments: assignmentsData };
        // --- END MOCK DATA SIMULATION ---
        
        if (result.success) {
          tbody.innerHTML = ''; // Clear existing rows
          
          result.assignments.forEach(assignment => {
            const row = document.createElement('tr');
            row.innerHTML = `
              <td>ASSIGN-${assignment.assignment_id.toString().padStart(3, '0')}</td>
              <td>CRIME-${assignment.crime_id.toString().padStart(3, '0')}</td>
              <td>${assignment.full_name || assignment.username || 'Unassigned'}</td>
              <td>${assignment.duty_role}</td>
              <td>${new Date(assignment.assigned_at).toLocaleString()}</td>
              <td><span class="status-badge status-${assignment.status.replace('_', '-')}">${assignment.status.replace('_', ' ')}</span></td>
              <td>
                <button class="btn btn-primary" onclick="updateCaseStatus(${assignment.assignment_id})">
                  <span>📝</span>
                  Update Status
                </button>
                <button class="btn btn-secondary" onclick="viewStatusHistory(${assignment.crime_id})">
                  <span>📊</span>
                  View History
                </button>
              </td>
            `;
            tbody.appendChild(row);
          });
        } else {
             tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: var(--accent-red);">Failed to load assignments.</td></tr>';
        }
      } catch (error) {
        console.error('Process Error loading case assignments:', error);
        tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: var(--accent-red);">An error occurred while processing assignment data.</td></tr>';
      }
    }

    // Complaint verification functions
    async function verifyComplaint(complaintId) {
      const numericId = Number(complaintId);
      if (!Number.isFinite(numericId) || numericId <= 0) {
        showAlert('Invalid complaint reference. Please refresh the page.');
        return;
      }

      const displayId = `COMP-${String(numericId).padStart(3, '0')}`;
      const record = complaintsCache.get(numericId);
      if (record && (record.status || '').toLowerCase() === 'verified') {
        showAlert(`${displayId} is already verified.`);
        return;
      }

      showConfirm(`Verify ${displayId}? This will mark the report as ready for escalation.`, async confirmed => {
        if (!confirmed) {
          return;
        }

        try {
          const response = await fetch(resolveApiUrl(`/api/crimes/${numericId}/status`), {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              crime_id: numericId,
              new_status: 'Verified',
              notes: 'Verified via admin dashboard',
              changed_by: CURRENT_ADMIN_ID
            })
          });

          const payload = await response.json().catch(() => ({}));
          if (!response.ok) {
            const message = payload.detail || payload.message || 'Failed to verify the complaint.';
            throw new Error(message);
          }

          showAlert(`${displayId} has been verified successfully.`);
          await loadComplaints();
        } catch (error) {
          console.error('Error verifying complaint:', error);
          showAlert(`Unable to verify ${displayId}: ${error.message || 'Unknown error'}`);
        }
      });
    }

    async function rejectComplaint(complaintId) {
      const numericId = Number(complaintId);
      if (!Number.isFinite(numericId) || numericId <= 0) {
        showAlert('Invalid complaint reference. Please refresh the page.');
        return;
      }

      const displayId = `COMP-${String(numericId).padStart(3, '0')}`;
      const record = complaintsCache.get(numericId);
      if (!record) {
        showAlert(`Unable to locate ${displayId}. Please reload the reports list.`);
        return;
      }

      if ((record.status || '').toLowerCase() !== 'pending') {
        showAlert(`${displayId} can no longer be rejected because it is not pending.`);
        return;
      }

      showConfirm(`Reject ${displayId}? This will permanently remove the report from the system.`, async confirmed => {
        if (!confirmed) {
          return;
        }

        try {
          const response = await fetch(resolveApiUrl(`/api/crimes/${numericId}`), { method: 'DELETE' });
          const payload = await response.json().catch(() => ({}));
          if (!response.ok) {
            const message = payload.detail || payload.message || 'Failed to reject the complaint.';
            throw new Error(message);
          }

          showAlert(`${displayId} has been rejected and removed.`);
          await loadComplaints();
        } catch (error) {
          console.error('Error rejecting complaint:', error);
          showAlert(`Unable to reject ${displayId}: ${error.message || 'Unknown error'}`);
        }
      });
    }

    async function escalateToCrime(complaintId) {
      const numericId = Number(complaintId);
      if (!Number.isFinite(numericId) || numericId <= 0) {
        showAlert('Invalid complaint reference. Please refresh the page.');
        return;
      }

      const displayId = `COMP-${String(numericId).padStart(3, '0')}`;
      const record = complaintsCache.get(numericId);
      if (!record) {
        showAlert(`Unable to locate ${displayId}. Try refreshing the reports list.`);
        return;
      }

      if ((record.status || '').toLowerCase() !== 'verified') {
        showAlert(`Please verify ${displayId} before escalating it to case management.`);
        return;
      }

      showConfirm(`Escalate ${displayId} to case management?`, async confirmed => {
        if (!confirmed) {
          return;
        }

        try {
          const response = await fetch(resolveApiUrl(`/api/crimes/${numericId}/status`), {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              crime_id: numericId,
              new_status: 'Under Investigation',
              notes: 'Escalated to case management',
              changed_by: CURRENT_ADMIN_ID
            })
          });

          const payload = await response.json().catch(() => ({}));
          if (!response.ok) {
            const message = payload.detail || payload.message || 'Failed to escalate the complaint.';
            throw new Error(message);
          }

          showAlert(`${displayId} has been escalated to case management.`);
          await loadComplaints();
          showTab('case-management');
        } catch (error) {
          console.error('Error escalating complaint:', error);
          showAlert(`Unable to escalate ${displayId}: ${error.message || 'Unknown error'}`);
        }
      });
    }

    function viewComplaintDetails(complaintId) {
      const numericId = Number(complaintId);
      if (!Number.isFinite(numericId) || numericId <= 0) {
        showAlert('Invalid complaint reference. Please refresh the page.');
        return;
      }

      const record = complaintsCache.get(numericId);
      if (!record) {
        showAlert('Unable to find the report details. Please reload and try again.');
        return;
      }

      const displayId = `COMP-${String(numericId).padStart(3, '0')}`;
      const statusInfo = normalizeStatus(record.status || 'Pending');
      const reportedAt = escapeHtml(formatDateTimeDisplay(record.created_at));
      const locationSummary = escapeHtml(formatIncidentLocation(record.location_data));
      const reporterContact = escapeHtml(deriveReporterContact(record));
      const crimeType = escapeHtml(record?.crime_data?.type || 'Not provided');
      const statusBadge = `<span class="status-badge ${statusInfo.className}">${escapeHtml(statusInfo.display)}</span>`;

      const incidentItems = [
        `<li><strong>Status:</strong> ${statusBadge}</li>`,
        `<li><strong>Reported:</strong> ${reportedAt}</li>`,
        `<li><strong>Location:</strong> ${locationSummary}</li>`,
        `<li><strong>Reporter Contact:</strong> ${reporterContact}</li>`,
        `<li><strong>Incident Type:</strong> ${crimeType}</li>`
      ].join('');

      const descriptionBlock = record?.crime_data?.description
        ? `<div class="stats-insights"><h4>Description</h4><p>${escapeHtml(record.crime_data.description)}</p></div>`
        : '';

      const victim = record?.victim_data && typeof record.victim_data === 'object' ? record.victim_data : null;
      const victimItems = victim ? [
        victim.name ? `<li><strong>Name:</strong> ${escapeHtml(victim.name)}</li>` : null,
        victim.phone ? `<li><strong>Phone:</strong> ${escapeHtml(victim.phone)}</li>` : null,
        victim.email ? `<li><strong>Email:</strong> ${escapeHtml(victim.email)}</li>` : null,
        victim.gender ? `<li><strong>Gender:</strong> ${escapeHtml(victim.gender)}</li>` : null,
        victim.injury_details ? `<li><strong>Injuries:</strong> ${escapeHtml(victim.injury_details)}</li>` : null
      ].filter(Boolean).join('') : '';
      const victimBlock = victimItems
        ? `<div class="stats-insights"><h4>Victim Details</h4><ul>${victimItems}</ul></div>`
        : '';

      const witness = record?.witness_data && typeof record.witness_data === 'object' ? record.witness_data : null;
      const witnessItems = witness ? [
        witness.name ? `<li><strong>Name:</strong> ${escapeHtml(witness.name)}</li>` : null,
        witness.phone ? `<li><strong>Phone:</strong> ${escapeHtml(witness.phone)}</li>` : null,
        witness.protection_required ? `<li><strong>Protection Required:</strong> ${escapeHtml(witness.protection_required)}</li>` : null
      ].filter(Boolean).join('') : '';
      const witnessBlock = witnessItems
        ? `<div class="stats-insights"><h4>Witness Details</h4><ul>${witnessItems}</ul></div>`
        : '';

      const evidenceList = coerceEvidenceList(record.evidence_files);
      const evidenceItems = evidenceList
        .map((item, index) => {
          if (!item) {
            return null;
          }
          const label = escapeHtml(item.original_name || item.filename || `Evidence ${index + 1}`);
          const url = item.url || item.file_url;
          if (url) {
            return `<li><a href="${escapeHtml(url)}" target="_blank" rel="noopener">${label}</a></li>`;
          }
          return `<li>${label}</li>`;
        })
        .filter(Boolean)
        .join('');
      const evidenceBlock = evidenceItems
        ? `<div class="stats-insights"><h4>Evidence</h4><ul>${evidenceItems}</ul></div>`
        : '';

      modalContainer.classList.add('modal-wide');
      modalMessage.innerHTML = `
        <div class="stats-modal">
          <div class="stats-header">
            <h3>${escapeHtml(displayId)}</h3>
            <p>${reportedAt} · ${escapeHtml(statusInfo.display)}</p>
          </div>
          <div class="stats-insights"><h4>Incident Summary</h4><ul>${incidentItems}</ul></div>
          ${descriptionBlock}
          ${victimBlock}
          ${witnessBlock}
          ${evidenceBlock}
        </div>
      `;

      modalButtons.innerHTML = '';
      modalButtons.classList.remove('stacked');

      const closeButton = document.createElement('button');
      closeButton.className = 'btn btn-primary';
      closeButton.textContent = 'Close';
      closeButton.onclick = () => closeModal();
      modalButtons.appendChild(closeButton);

      modalOverlay.classList.add('show');
    }

    // Case management functions
    function updateCaseStatus(assignmentId) {
      console.log(`Attempting to update status for assignment ${assignmentId}`);
      // NOTE: Replacing prompt() with an informative modal.
      showAlert(`To update the case status for ASSIGN-${assignmentId.toString().padStart(3, '0')}, a full modal form with status selection and notes field would appear here for data entry.`);
    }

    function viewStatusHistory(crimeId) {
      console.log(`Viewing status history for crime: ${crimeId}`);
      showAlert(`Loading status history and timeline for CRIME-${crimeId.toString().padStart(3, '0')}...`);
    }

    function viewCrimeDetails(crimeId) {
      console.log(`Viewing crime details: ${crimeId}`);
      showAlert(`Loading crime details and AI-generated summary for CRIME-${crimeId.toString().padStart(3, '0')}...`);
    }

    async function openUserActions(userId) {
      const numericId = Number(userId);
      if (!Number.isFinite(numericId) || numericId <= 0) {
        showAlert('Unable to determine which user to manage. Please refresh and try again.');
        return;
      }

      let user = adminUsersCache.get(numericId);

      if (!user) {
        try {
          const response = await fetch(resolveApiUrl(`/api/admin/users/${numericId}`), { cache: 'no-store' });
          if (!response.ok) {
            throw new Error(`Request failed with status ${response.status}`);
          }
          const payload = await response.json().catch(() => ({}));
          if (payload && payload.user) {
            user = payload.user;
            adminUsersCache.set(numericId, user);
          }
        } catch (error) {
          console.error('Error loading user details:', error);
          showAlert('Unable to load user details at this time.');
          return;
        }
      }

      if (!user) {
        showAlert('User details are unavailable.');
        return;
      }

      const currentRole = (user.role_hint || 'User').trim();
      modalMessage.innerHTML = `
        <h3 style="margin-bottom: 0.75rem;">Manage ${user.username || user.email || `USR-${String(numericId).padStart(3, '0')}`}</h3>
        <p style="margin-bottom: 0.25rem; color: var(--text-secondary);">Current role: <strong>${currentRole}</strong></p>
        <p style="color: var(--text-secondary);">Select a new role to assign to this user.</p>
      `;

      modalButtons.innerHTML = '';
      modalButtons.classList.add('stacked');

      ROLE_ACTIONS.forEach(action => {
        const actionButton = document.createElement('button');
        actionButton.className = action.className;
        actionButton.textContent = action.label;
        const isCurrentRole = currentRole.toLowerCase() === action.value.toLowerCase();
        if (isCurrentRole) {
          actionButton.disabled = true;
          actionButton.title = 'User already has this role';
        }
        actionButton.onclick = () => updateUserRole(numericId, action.value, actionButton);
        modalButtons.appendChild(actionButton);
      });

      const cancelButton = document.createElement('button');
      cancelButton.className = 'btn btn-secondary';
      cancelButton.textContent = 'Cancel';
      cancelButton.onclick = () => {
        modalButtons.classList.remove('stacked');
        closeModal();
      };
      modalButtons.appendChild(cancelButton);

      modalOverlay.classList.add('show');
    }

    async function updateUserRole(userId, targetRole, sourceButton) {
      const button = sourceButton || null;
      const originalText = button ? button.textContent : '';

      if (button) {
        button.disabled = true;
        button.textContent = 'Updating...';
      }

      try {
        const response = await fetch(resolveApiUrl(`/api/admin/users/${userId}`), {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ user_id: userId, role_hint: targetRole })
        });

        if (!response.ok) {
          const errorPayload = await response.json().catch(() => ({}));
          let errorMessage = errorPayload.detail || errorPayload.error || `Request failed with status ${response.status}`;
          if (Array.isArray(errorMessage)) {
            errorMessage = errorMessage.map(item => item.msg || JSON.stringify(item)).join('\n');
          }
          throw new Error(errorMessage);
        }

        adminUsersCache.delete(userId);
        modalButtons.classList.remove('stacked');
        closeModal();
        await loadUsers();
        showAlert(`User role updated to ${targetRole}.`);
      } catch (error) {
        console.error('Error updating user role:', error);
        showAlert(error.message || 'Failed to update user role.');
      } finally {
        if (button) {
          button.disabled = false;
          button.textContent = originalText;
        }
      }
    }

    // Replace the existing load functions with these database-connected versions:

    // Load users from database
    async function loadUsers() {
      const tbody = document.getElementById('users-table');
      if (!tbody) {
        return;
      }

      tbody.innerHTML = '<tr><td colspan="7" style="text-align: center;">Loading users...</td></tr>';

      try {
        const response = await fetch(resolveApiUrl('/api/admin/users?limit=100'), { cache: 'no-store' });
        if (!response.ok) {
          throw new Error(`Request failed with status ${response.status}`);
        }

        const payload = await response.json().catch(() => ({}));
        const users = Array.isArray(payload.users) ? payload.users : [];

        if (users.length === 0) {
          tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: var(--text-secondary);">No users found.</td></tr>';
          return;
        }

        adminUsersCache.clear();
        users.forEach(user => {
          const idValue = Number(user.user_id ?? user.id);
          if (Number.isFinite(idValue)) {
            adminUsersCache.set(idValue, user);
          }
        });

        renderUserRows(users, tbody);
      } catch (error) {
        console.error('Error loading users from API:', error);
        tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: var(--accent-red);">Unable to load users right now.</td></tr>';
      }
    }

    // Load wanted criminals from database
    async function loadWantedCriminals() {
      const tbody = document.getElementById('wanted-criminals-table');
      if (!tbody) {
        return;
      }

      tbody.innerHTML = '<tr><td colspan="8" style="text-align: center;">Loading wanted criminals...</td></tr>';

      try {
        const response = await fetch(resolveApiUrl('/api/wanted-criminals'), { cache: 'no-store' });
        if (!response.ok) {
          throw new Error(`Request failed with status ${response.status}`);
        }

        const payload = await response.json().catch(() => []);
        const criminals = Array.isArray(payload)
          ? payload
          : (Array.isArray(payload.wanted_criminals) ? payload.wanted_criminals : []);

        wantedCriminalCache.clear();
        const activeCriminals = [];

        criminals.forEach(record => {
          const idValue = Number(record.criminal_id ?? record.id);
          if (Number.isFinite(idValue)) {
            wantedCriminalCache.set(idValue, record);
          }

          const statusRaw = (record.status || '').toString().trim().toLowerCase();
          if (statusRaw !== 'captured') {
            activeCriminals.push(record);
          }
        });

        renderWantedCriminalRows(activeCriminals, tbody);
      } catch (error) {
        console.error('Error loading criminals:', error);
        tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: var(--accent-red);">Unable to load wanted criminals right now.</td></tr>';
      }
    }

    // Load police stations from database
    async function loadPoliceStations() {
      const tbody = document.getElementById('stations-table');
      if (!tbody) {
        return;
      }

    tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: var(--text-secondary);">Loading stations…</td></tr>';


      try {
        const response = await fetch(resolveApiUrl('/api/admin/police-stations'), { cache: 'no-store' });
        if (!response.ok) {
          throw new Error(`Request failed with status ${response.status}`);
        }

        const payload = await response.json().catch(() => ({}));
        const records = Array.isArray(payload.police_stations)
          ? payload.police_stations
          : (Array.isArray(payload) ? payload : []);

        policeStationCache.clear();
        records.forEach(record => {
          const stationId = Number(record.station_id ?? record.id);
          if (Number.isFinite(stationId)) {
            policeStationCache.set(stationId, record);
          }
        });

        renderPoliceStationRows(records, tbody);
      } catch (error) {
        console.error('Error loading stations:', error);
        tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: var(--accent-red);">Unable to load police stations right now.</td></tr>';
      }
    }

    // Load missing persons from database
    async function loadMissingPersons() {
      const tbody = document.getElementById('missing-persons-table');
      if (!tbody) {
        return;
      }

      tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; color: var(--text-secondary);">Loading missing person reports…</td></tr>';

      try {
        const response = await fetch(resolveApiUrl('/api/missing-persons'), { cache: 'no-store' });
        if (!response.ok) {
          throw new Error(`Request failed with status ${response.status}`);
        }

        const payload = await response.json().catch(() => ({}));
        const records = Array.isArray(payload.missing_persons)
          ? payload.missing_persons
          : (Array.isArray(payload) ? payload : []);

        missingPersonsCache.clear();
        records.forEach(record => {
          const missingId = Number(record.missing_id ?? record.id);
          if (Number.isFinite(missingId)) {
            missingPersonsCache.set(missingId, record);
          }
        });

        renderMissingPersonRows(records, tbody);
      } catch (error) {
        console.error('Error loading missing persons:', error);
        tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; color: var(--accent-red);">Unable to load missing person reports right now.</td></tr>';
      }
    }

    // Load analytics from database
    async function loadAnalytics() {
      const overviewContainer = document.getElementById('analytics-overview');
      const activityContainer = document.getElementById('activity-log');

      if (!overviewContainer || !activityContainer) {
        return;
      }

      overviewContainer.innerHTML = `
        <div class="analytics-card">
          <span class="metric-label">Loading metrics…</span>
          <span class="metric-sub">Retrieving live statistics from the database.</span>
        </div>
      `;
      activityContainer.innerHTML = '<div class="activity-item"><span>Loading recent activity…</span></div>';

      try {
        const response = await fetch(resolveApiUrl('/api/admin/analytics?limit=15'), { cache: 'no-store' });
        if (!response.ok) {
          throw new Error(`Analytics request failed with status ${response.status}`);
        }

        const payload = await response.json().catch(() => ({}));
        displayAnalytics(payload);
      } catch (error) {
        console.error('Error loading analytics:', error);
        overviewContainer.innerHTML = `
          <div class="analytics-card">
            <span class="metric-label">Analytics unavailable</span>
            <span class="metric-sub">Unable to reach the analytics endpoint right now.</span>
          </div>
        `;
        activityContainer.innerHTML = '<div class="activity-item"><span>Recent activity could not be loaded.</span></div>';
      }
    }

    // Display functions (add these if they don't exist)
    function displayUsers(users) {
      const tbody = document.getElementById('users-table');
      if (!tbody) {
        return;
      }
      renderUserRows(users, tbody);
    }
    function displayPoliceStations(stations) {
      const tbody = document.getElementById('stations-table');
      if (!tbody) {
        return;
      }
      renderPoliceStationRows(stations, tbody);
    }

    function displayMissingPersons(persons) {
      const tbody = document.getElementById('missing-persons-table');
      if (!tbody) {
        return;
      }
      renderMissingPersonRows(persons, tbody);
    }

    function displayAnalytics(payload) {
      const overviewContainer = document.getElementById('analytics-overview');
      const activityContainer = document.getElementById('activity-log');

      if (!overviewContainer || !activityContainer) {
        return;
      }

      const cards = Array.isArray(payload.summary_cards) ? payload.summary_cards : [];
      const activity = Array.isArray(payload.activity) ? payload.activity : [];

      overviewContainer.innerHTML = cards.length
        ? cards.map(card => {
            const value = formatNumberDisplay(card.value ?? 0);
            const subtitle = card.subtitle ? escapeHtml(card.subtitle) : '';
            const delta = card.delta ? escapeHtml(card.delta) : '';
            const trendClass = card.trend === 'down' ? 'negative' : card.trend === 'up' ? 'positive' : '';
            const iconMarkup = card.icon ? `<span class="metric-icon">${escapeHtml(card.icon)}</span>` : '';
            return `
              <div class="analytics-card">
                <div class="analytics-card-header">
                  <span class="metric-label">${escapeHtml(card.title || 'Metric')}</span>
                  ${iconMarkup}
                </div>
                <span class="metric-value">${value}</span>
                ${subtitle ? `<span class="metric-sub">${subtitle}</span>` : ''}
                ${delta ? `<span class="metric-trend ${trendClass}">${delta}</span>` : ''}
              </div>
            `;
          }).join('')
        : '<div class="analytics-card"><span class="metric-label">No analytics available.</span></div>';

      activityContainer.innerHTML = activity.length
        ? activity.map(entry => {
            const typeLabel = escapeHtml(entry.type || 'Activity');
            const title = entry.title ? escapeHtml(entry.title) : '';
            const description = entry.description ? escapeHtml(entry.description) : '';
            const metaId = entry.reference_id !== undefined && entry.reference_id !== null
              ? `#${escapeHtml(String(entry.reference_id))}`
              : '—';
            const statusInfo = normalizeStatus(entry.status || 'Pending');
            const statusLabel = escapeHtml(statusInfo.display || 'Pending');
            const timestamp = formatDateTimeDisplay(entry.timestamp);
            return `
              <div class="activity-item">
                <div class="activity-item-header">
                  <span class="activity-item-type">${typeLabel}</span>
                  <span class="activity-item-status ${statusInfo.className}">${statusLabel}</span>
                </div>
                ${title ? `<div class="activity-item-title">${title}</div>` : ''}
                ${description ? `<div class="activity-item-description">${description}</div>` : ''}
                <div class="activity-item-meta">
                  <span>${metaId}</span>
                  <span>${timestamp}</span>
                </div>
              </div>
            `;
          }).join('')
        : '<div class="activity-item"><span>No recent activity recorded.</span></div>';
    }

    function showUserStatsModal(statsSummary) {
      const {
        totalUsers,
        recentRegistrations,
        roleDistribution,
        statusDistribution
      } = statsSummary;

      const activeEntry = statusDistribution.find(item => (item.label || '').toLowerCase() === 'active');
      const activeCount = activeEntry ? activeEntry.count : 0;
      const activeRate = totalUsers ? ((activeCount / totalUsers) * 100).toFixed(1) : '0.0';
      const topRole = roleDistribution.reduce((best, current) => {
        if (!best || current.count > best.count) {
          return current;
        }
        return best;
      }, null);

      const metrics = [
        { label: 'Total Users', value: totalUsers },
        { label: 'New (30 Days)', value: recentRegistrations, prefix: '+' },
        { label: 'Unique Roles', value: roleDistribution.length },
        { label: 'Active Accounts', value: activeCount }
      ];

      const roleLabels = roleDistribution.map(item => item.label);
      const roleCounts = roleDistribution.map(item => item.count);
      const statusLabels = statusDistribution.map(item => item.label);
      const statusCounts = statusDistribution.map(item => item.count);

      const hasRoleData = roleCounts.some(count => count > 0);
      const hasStatusData = statusCounts.some(count => count > 0);
      const chartLibraryLoaded = typeof Chart !== 'undefined';
      const roleEmptyMessage = chartLibraryLoaded ? 'Role data is not available yet.' : 'Charts unavailable in this environment.';
      const statusEmptyMessage = chartLibraryLoaded ? 'Status data is not available yet.' : 'Charts unavailable in this environment.';

      const insights = [
        topRole ? `Most common role: <strong>${topRole.label}</strong> (${formatNumberDisplay(topRole.count)})` : null,
        totalUsers ? `Active rate: <strong>${activeRate}%</strong>` : null,
        roleDistribution.length ? `Role diversity: <strong>${formatNumberDisplay(roleDistribution.length)}</strong> roles in use` : null
      ].filter(Boolean);

      const insightsBlock = insights.length ? `
        <div class="stats-insights">
          <h4>Quick Insights</h4>
          <ul>
            ${insights.map(item => `<li>${item}</li>`).join('')}
          </ul>
        </div>
      ` : '';

      modalContainer.classList.add('modal-wide');

      modalMessage.innerHTML = `
        <div class="stats-modal">
          <div class="stats-header">
            <h3>User Statistics</h3>
            <p>Live snapshot of account distribution and onboarding momentum.</p>
          </div>
          <div class="stats-layout">
            <div class="stats-metrics-card">
              <div class="stats-metrics">
                ${metrics.map(metric => `
                  <div class="stats-metric">
                    <span class="metric-label">${metric.label}</span>
                    <span class="metric-value">${metric.prefix || ''}${formatNumberDisplay(metric.value ?? 0)}</span>
                  </div>
                `).join('')}
              </div>
            </div>
            <div class="stats-chart">
              <h4>Role Distribution</h4>
              ${hasRoleData && chartLibraryLoaded
                ? '<div class="chart-wrapper"><canvas id="role-distribution-chart"></canvas></div>'
                : `<div class="stats-empty-state">${roleEmptyMessage}</div>`}
            </div>
            ${insightsBlock}
            <div class="stats-chart">
              <h4>Status Distribution</h4>
              ${hasStatusData && chartLibraryLoaded
                ? '<div class="chart-wrapper"><canvas id="status-distribution-chart"></canvas></div>'
                : `<div class="stats-empty-state">${statusEmptyMessage}</div>`}
            </div>
          </div>
        </div>
      `;

      modalButtons.innerHTML = '';
      modalButtons.classList.remove('stacked');

      const closeButton = document.createElement('button');
      closeButton.className = 'btn btn-primary';
      closeButton.textContent = 'Close';
      closeButton.onclick = () => closeModal();
      modalButtons.appendChild(closeButton);

      modalOverlay.classList.add('show');

      requestAnimationFrame(() => {
        if (hasRoleData && chartLibraryLoaded) {
          renderDoughnutChart('role-distribution-chart', roleLabels, roleCounts, 'role');
        }
        if (hasStatusData && chartLibraryLoaded) {
          renderDoughnutChart('status-distribution-chart', statusLabels, statusCounts, 'status');
        }
      });
    }

    async function showUserStats() {
      try {
        const response = await fetch(resolveApiUrl('/api/admin/user-stats'), { cache: 'no-store' });
        if (!response.ok) {
          throw new Error(`Request failed with status ${response.status}`);
        }

        const stats = await response.json();

        const roleDistribution = (Array.isArray(stats.role_distribution) ? stats.role_distribution : [])
          .map(entry => ({
            label: entry.role_hint || 'Unknown',
            count: Number(entry.count) || 0
          }))
          .filter(item => item.count >= 0)
          .sort((a, b) => b.count - a.count);

        const statusDistribution = (Array.isArray(stats.status_distribution) ? stats.status_distribution : [])
          .map(entry => ({
            label: entry.status || 'Unknown',
            count: Number(entry.count) || 0
          }))
          .filter(item => item.count >= 0)
          .sort((a, b) => b.count - a.count);

        showUserStatsModal({
          totalUsers: Number(stats.total_users) || 0,
          recentRegistrations: Number(stats.recent_registrations) || 0,
          roleDistribution,
          statusDistribution
        });
      } catch (error) {
        console.error('Error fetching user statistics:', error);
        showAlert('Unable to load user statistics right now. Please try again later.');
      }
    }

    document.addEventListener('click', event => {
      const badge = event.target.closest('.status-clickable');
      if (badge) {
        event.preventDefault();
        const missingId = Number(badge.dataset.missingId);
        if (Number.isFinite(missingId) && missingId > 0) {
          showMissingPersonFinder(missingId);
          return;
        }
        const criminalId = Number(badge.dataset.criminalId);
        if (Number.isFinite(criminalId) && criminalId > 0) {
          showSightingHistory(criminalId);
        }
        return;
      }

      const stationBtn = event.target.closest('[data-action="view-station"]');
      if (stationBtn) {
        event.preventDefault();
        const stationId = Number(stationBtn.dataset.stationId);
        if (Number.isFinite(stationId) && stationId > 0) {
          viewPoliceStation(stationId);
        } else {
          showAlert('Station details are not available for this entry.');
        }
        return;
      }

      const missingBtn = event.target.closest('[data-action="view-missing"]');
      if (missingBtn) {
        event.preventDefault();
        const missingId = Number(missingBtn.dataset.missingId);
        if (Number.isFinite(missingId) && missingId > 0) {
          viewMissingPerson(missingId);
        } else {
          showAlert('Missing person details are not available for this entry.');
        }
        return;
      }
    });

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', () => loadCrimesOverview());
    } else {
      loadCrimesOverview();
    }
    </script>
  </body>
</html>
